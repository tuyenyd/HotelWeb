<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Tất cả khách hàng - HotelAdmin</title>
    <link href="assets/img/img.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

    <link href="assets/css/style.css" rel="stylesheet">

    <style>
        .customer-card {
            transition: all 0.3s ease;
            border-left: 4px solid #4154f1;
        }
        .customer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .customer-card.vip {
            border-left-color: #ffc107;
        }
        .customer-card.enterprise {
            border-left-color: #6f42c1;
        }
        .customer-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
            font-weight: bold;
        }
        .stats-badge {
            font-size: 0.75rem;
            padding: 0.35em 0.65em;
        }
        .last-booking {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .loyalty-level {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }
        .level-bronze { background: #cd7f32; }
        .level-silver { background: #c0c0c0; color: #222;}
        .level-gold { background: #ffd700; color: #222; }
        .level-platinum { background: #e5e4e2; color: #222; }
        .tab-content {
            min-height: 350px;
        }
        .booking-history-item {
            border-left: 3px solid #4154f1;
            padding-left: 15px;
            margin-bottom: 15px;
        }
        .points-history {
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .benefit-list { list-style: none; padding: 0; }
        .benefit-list li { padding: 0.25rem 0; font-size: 0.9rem;}
        .benefit-list li i { margin-right: 0.5rem;}
        .loading-indicator { color: #6c757d; }
        .customer-stats .col-4 { border-right: 1px solid #eee; }
        .customer-stats .col-4:last-child { border-right: none; }
    </style>
</head>
<body>
<header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
        <a href="index.html" class="logo d-flex align-items-center">
            <img src="assets/img/logo.png" alt="Logo">
            <span class="d-none d-lg-block">Grandoria</span>
        </a>
        <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><div class="search-bar">
    <form class="search-form d-flex align-items-center" method="POST" action="#">
        <input type="text" name="query" placeholder="Tìm kiếm đặt phòng, khách hàng..." title="Nhập từ khóa tìm kiếm">
        <button type="submit" title="Tìm kiếm"><i class="bi bi-search"></i></button>
    </form>
</div><nav class="header-nav ms-auto">
    <ul class="d-flex align-items-center">

        <li class="nav-item d-block d-lg-none">
            <a class="nav-link nav-icon search-bar-toggle " href="#">
                <i class="bi bi-search"></i>
            </a>
        </li><li class="nav-item dropdown">
        <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-bell"></i>
            <span class="badge bg-primary badge-number">3</span>
        </a><ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications">
        <li class="dropdown-header">
            Bạn có 3 thông báo mới
            <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">Xem tất cả</span></a>
        </li>
        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-exclamation-circle text-warning"></i>
            <div>
                <h4>Đặt phòng mới</h4>
                <p>Khách hàng Nguyễn Văn A vừa đặt phòng Deluxe</p>
                <p>5 phút trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-x-circle text-danger"></i>
            <div>
                <h4>Hủy đặt phòng</h4>
                <p>Đặt phòng #2457 đã bị hủy</p>
                <p>2 giờ trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-check-circle text-success"></i>
            <div>
                <h4>Phản hồi mới</h4>
                <p>Bạn có 2 đánh giá mới từ khách hàng</p>
                <p>4 giờ trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>
        <li class="dropdown-footer">
            <a href="#">Hiển thị tất cả thông báo</a>
        </li>
    </ul></li><li class="nav-item dropdown pe-3">

        <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <img src="assets/img/profile-img.jpg" alt="Hồ sơ" class="rounded-circle">
            <span class="d-none d-md-block dropdown-toggle ps-2" id="profileName">Đang tải...</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li class="dropdown-header">
                <h6 id="profileDropdownName">...</h6>
                <span id="profileDropdownRole">...</span>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                    <i class="bi bi-person"></i>
                    <span>Hồ sơ của tôi</span>
                </a>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                    <i class="bi bi-gear"></i>
                    <span>Cài đặt tài khoản</span>
                </a>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="#" id="logoutButton">
                    <i class="bi bi-box-arrow-right"></i>
                    <span>Đăng xuất</span>
                </a>
            </li>
        </ul></li></ul>
</nav>
</header><aside id="sidebar" class="sidebar">

    <ul class="sidebar-nav" id="sidebar-nav">

        <li class="nav-item">
            <a class="nav-link " href="index.html">
                <i class="bi bi-house-door"></i>
                <span>Bảng Điều Khiển</span>
            </a>
        </li><li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#booking-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-calendar-check"></i><span>Quản lý Đặt phòng</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="booking-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
            <li>
                <a href="tatcadatphong.html">
                    <i class="bi bi-circle"></i><span>Tất cả đặt phòng</span>
                </a>
            </li>
            <li>
                <a href="checkin.html">
                    <i class="bi bi-circle"></i><span>Check-in</span>
                </a>
            </li>
            <li>
                <a href="checkout.html">
                    <i class="bi bi-circle"></i><span>Check-out</span>
                </a>
            </li>
        </ul>
    </li><li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#room-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-door-closed"></i><span>Quản lý Phòng</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="room-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
            <li>
                <a href="danhsachphong.html">
                    <i class="bi bi-circle"></i><span>Danh sách phòng</span>
                </a>
            </li>
            <li>
                <a href="loaiphong.html">
                    <i class="bi bi-circle"></i><span>Loại phòng</span>
                </a>
            </li>
            <li>
                <a href="tinhtrangphong.html">
                    <i class="bi bi-circle"></i><span>Tình trạng phòng</span>
                </a>
            </li>
            <li>
                <a href="giaphong.html">
                    <i class="bi bi-circle"></i><span>Giá phòng</span>
                </a>
            </li>
        </ul>
    </li><li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#customer-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-people"></i><span>Quản lý Khách hàng</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="customer-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
            <li>
                <a href="danhsachkhachhang.html">
                    <i class="bi bi-circle"></i><span>Danh sách khách hàng</span>
                </a>
            </li>
            <li>
                <a href="chuongtrinhthanhvien.html">
                    <i class="bi bi-circle"></i><span>Chương trình thành viên</span>
                </a>
            </li>
            <li>
                <a href="danhgia&phanhoi.html">
                    <i class="bi bi-circle"></i><span>Đánh giá & Phản hồi</span>
                </a>
            </li>
        </ul>
    </li><li class="nav-item">
        <a class="nav-link collapsed" href="baocao&thongke.html">
            <i class="bi bi-bar-chart"></i>
            <span>Báo cáo & Thống kê</span>
        </a>
    </li><li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#finance-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-cash-coin"></i><span>Tài chính</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="finance-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
            <li>
                <a href="finance-invoices.html">
                    <i class="bi bi-circle"></i><span>Hóa đơn</span>
                </a>
            </li>
            <li>
                <a href="finance-payments.html">
                    <i class="bi bi-circle"></i><span>Thanh toán</span>
                </a>
            </li>
            <li>
                <a href="finance-revenue.html">
                    <i class="bi bi-circle"></i><span>Doanh thu</span>
                </a>
            </li>
        </ul>
    </li><li class="nav-heading">Trang</li>

        <li class="nav-item">
            <a class="nav-link collapsed" href="users-profile.html">
                <i class="bi bi-person"></i>
                <span>Hồ sơ</span>
            </a>
        </li><li class="nav-item">
        <a class="nav-link collapsed" href="pages-contact.html">
            <i class="bi bi-envelope"></i>
            <span>Liên hệ</span>
        </a>
    </li><li class="nav-item">
        <a class="nav-link collapsed" href="users.html">
            <i class="bi bi-person-gear"></i>
            <span>Nhân viên</span>
        </a>
    </li>

        <li class="nav-item">
            <a class="nav-link collapsed" href="taikhoan.html">
                <i class="bi bi-person-badge"></i>
                <span>Tài khoản</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" href="settings.html">
                <i class="bi bi-gear"></i>
                <span>Cài đặt</span>
            </a>
        </li>
    </ul>

</aside>

<main id="main" class="main">
    <div class="pagetitle d-flex justify-content-between align-items-center">
        <h1>Tất cả khách hàng</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
                <li class="breadcrumb-item">Quản lý Khách hàng</li>
                <li class="breadcrumb-item active">Tất cả khách hàng</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="row">
            <div class="col-lg col-md-6"> <div class="card info-card">
                <div class="card-body">
                    <h5 class="card-title">Tổng khách hàng</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="ps-3">
                            <h6 id="statTotalCustomers">0</h6>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <div class="col-lg col-md-6">
                <div class="card info-card revenue-card"> <div class="card-body">
                    <h5 class="card-title">Thành viên mới (Bronze)</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background-color: #cd7f3233; color: #cd7f32;">
                            <i class="bi bi-person-plus"></i> </div>
                        <div class="ps-3">
                            <h6 id="statBronzeMembers">0</h6>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <div class="col-lg col-md-6">
                <div class="card info-card customers-card"> <div class="card-body">
                    <h5 class="card-title">Thành viên thân thiết (Silver)</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background-color: #c0c0c033; color: #777;">
                            <i class="bi bi-person-check"></i> </div>
                        <div class="ps-3">
                            <h6 id="statSilverMembers">0</h6>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <div class="col-lg col-md-6">
                <div class="card info-card sales-card"> <div class="card-body">
                    <h5 class="card-title">Thành viên VIP (Gold)</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-star"></i> </div>
                        <div class="ps-3">
                            <h6 id="statGoldMembers">0</h6> </div>
                    </div>
                </div>
                </div>
            </div>

            <div class="col-lg col-md-6">
                <div class="card info-card"> <div class="card-body">
                    <h5 class="card-title">Thành viên cao cấp (Platinum)</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background-color: #e5e4e233; color: #555;">
                            <i class="bi bi-gem"></i> </div>
                        <div class="ps-3">
                            <h6 id="statPlatinumMembers">0</h6> </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title">Quản lý khách hàng</h5>
                            <div>
                                <div class="btn-group me-2" role="group" aria-label="View toggle">
                                    <input type="radio" class="btn-check" name="customerViewMode" id="customerGridViewBtn" checked>
                                    <label class="btn btn-outline-primary" for="customerGridViewBtn" title="Xem lưới">
                                        <i class="bi bi-grid-3x3-gap"></i>
                                    </label>
                                    <input type="radio" class="btn-check" name="customerViewMode" id="customerListViewBtn">
                                    <label class="btn btn-outline-primary" for="customerListViewBtn" title="Xem danh sách">
                                        <i class="bi bi-list-ul"></i>
                                    </label>
                                </div>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                                    <i class="bi bi-person-plus"></i> Thêm khách hàng
                                </button>
                                <button class="btn btn-outline-primary ms-2" id="exportCustomers">
                                    <i class="bi bi-download"></i> Xuất Excel
                                </button>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-4"> <input type="text" class="form-control" id="searchCustomer" placeholder="Tìm theo tên, email, SĐT..."> </div> <div class="col-md-3"> <select class="form-select" id="filterType"> <option value="">Tất cả loại</option> <option value="vip">Thành viên VIP</option> <option value="enterprise">Thành viên cao cấp</option> <option value="regular">Thành viên thường</option> </select> </div> <div class="col-md-2"> <select class="form-select" id="filterLevel"> <option value="">Tất cả hạng</option> <option value="bronze">Bronze</option> <option value="silver">Silver</option> <option value="gold">Gold</option> <option value="platinum">Platinum</option> </select> </div> <div class="col-md-3"> <div class="btn-group w-100"> <button class="btn btn-outline-primary" id="searchButton">Tìm kiếm</button> <button class="btn btn-outline-secondary" id="resetFilters">Làm mới</button> </div> </div>
                        </div>

                        <div class="row" id="customerGridView">
                        </div>

                        <div class="table-responsive d-none" id="customerListView">
                            <table class="table table-hover align-middle">
                                <thead>
                                <tr>
                                    <th scope="col">Khách hàng</th>
                                    <th scope="col">Hạng & Điểm</th>
                                    <th scope="col">Liên hệ</th>
                                    <th scope="col">Thống kê (Đặt/Đêm/Chi)</th>
                                    <th scope="col" style="min-width: 120px;">Thao tác</th>
                                </tr>
                                </thead>
                                <tbody id="customerListBody">
                                </tbody>
                            </table>
                        </div>
                        <div id="noCustomerResult" class="text-center text-muted my-4" style="display:none;">
                            <i class="bi bi-emoji-frown fs-2"></i><br>
                            Không tìm thấy khách hàng phù hợp.
                        </div>
                        <nav aria-label="Page navigation" id="customerPagination">
                            <ul class="pagination justify-content-center">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<div class="modal fade" id="customerDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Hồ sơ Khách hàng: <span id="customerName">...</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="customerTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">Thông tin cá nhân</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button" role="tab">Lịch sử đặt phòng</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="loyalty-tab" data-bs-toggle="tab" data-bs-target="#loyalty" type="button" role="tab">Thành viên & Điểm</button>
                    </li>
                </ul>

                <div class="tab-content pt-3" id="customerTabContent">
                    <div class="tab-pane fade show active" id="profile" role="tabpanel">
                        <div class="row"> <div class="col-md-6"> <div class="mb-3"> <label class="form-label fw-bold">Họ và tên</label> <div id="detailName">...</div> </div> <div class="mb-3"> <label class="form-label fw-bold">Email</label> <div id="detailEmail">...</div> </div> <div class="mb-3"> <label class="form-label fw-bold">Số điện thoại</label> <div id="detailPhone">...</div> </div> </div> <div class="col-md-6"> <div class="mb-3"> <label class="form-label fw-bold">CCCD/CMND</label> <div id="detailCCCD">...</div> </div> <div class="mb-3"> <label class="form-label fw-bold">Ngày sinh</label> <div id="detailDOB">...</div> </div> <div class="mb-3"> <label class="form-label fw-bold">Địa chỉ</label> <div id="detailAddress">...</div> </div> </div> </div>
                    </div>

                    <div class="tab-pane fade" id="bookings" role="tabpanel">
                        <div class="booking-history"> <div class="text-center p-3 loading-indicator"> <div class="spinner-border spinner-border-sm" role="status"> <span class="visually-hidden">Loading...</span> </div> Đang tải lịch sử... </div> </div>
                    </div>

                    <div class="tab-pane fade" id="loyalty" role="tabpanel">
                        <div class="row"> <div class="col-md-6"> <div class="card h-100"> <div class="card-body" id="loyaltyInfoBody"> <div class="text-muted text-center p-3">Đang tải thông tin thành viên...</div> </div> </div> </div> <div class="col-md-6"> <div class="card h-100"> <div class="card-body"> <h6 class="card-title">Lịch sử điểm</h6> <div class="points-history"> <div class="text-center p-3 loading-indicator"> <div class="spinner-border spinner-border-sm" role="status"> <span class="visually-hidden">Loading...</span> </div> Đang tải lịch sử... </div> </div> </div> </div> </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">Thêm khách hàng mới</h5> <button type="button" class="btn-close" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="addCustomerForm"> <div class="row"> <div class="col-md-6"> <div class="mb-3"> <label class="form-label">Họ và tên *</label> <input type="text" class="form-control" id="addFullName" required> </div> </div> <div class="col-md-6"> <div class="mb-3"> <label class="form-label">Số điện thoại *</label> <input type="tel" class="form-control" id="addPhone" required> </div> </div> </div> <div class="row"> <div class="col-md-6"> <div class="mb-3"> <label class="form-label">Email</label> <input type="email" class="form-control" id="addEmail"> </div> </div> <div class="col-md-6"> <div class="mb-3"> <label class="form-label">CCCD/CMND *</label> <input type="text" class="form-control" id="addIdNumber" required> </div> </div> </div> <div class="row"> <div class="col-md-6"> <div class="mb-3"> <label class="form-label">Ngày sinh</label> <input type="date" class="form-control" id="addDateOfBirth"> </div> </div> <div class="col-md-6"> <div class="mb-3"> <label class="form-label">Địa chỉ</label> <input type="text" class="form-control" id="addAddress"> </div> </div> </div> </form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button> <button type="button" class="btn btn-primary">Thêm khách hàng</button> </div> </div> </div>
</div>
<div class="modal fade" id="editCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">Sửa thông tin khách hàng</h5> <button type="button" class="btn-close" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="editCustomerForm"> <input type="hidden" id="editCustomerId"> <div class="row"> <div class="col-md-6"> <div class="mb-3"> <label class="form-label">Họ và tên *</label> <input type="text" class="form-control" id="editName" required> </div> </div> <div class="col-md-6"> <div class="mb-3"> <label class="form-label">Số điện thoại *</label> <input type="tel" class="form-control" id="editPhone" required> </div> </div> </div> <div class="row"> <div class="col-md-6"> <div class="mb-3"> <label class="form-label">Email</label> <input type="email" class="form-control" id="editEmail"> </div> </div> <div class="col-md-6"> <div class="mb-3"> <label class="form-label">CCCD/CMND *</label> <input type="text" class="form-control" id="editCCCD" required> </div> </div> </div> <div class="row"> <div class="col-md-6"> <div class="mb-3"> <label class="form-label">Ngày sinh</label> <input type="date" class="form-control" id="editDOB"> </div> </div> <div class="col-md-6"> <div class="mb-3"> <label class="form-label">Địa chỉ</label> <input type="text" class="form-control" id="editAddress"> </div> </div> </div> </form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button> <button type="button" class="btn btn-primary" id="saveEditCustomer">Lưu thay đổi</button> </div> </div> </div>
</div>

<footer id="footer" class="footer">
    <div class="copyright"> &copy; Bản quyền <strong><span>HotelAdmin</span></strong>. Tất cả các quyền được bảo lưu </div> <div class="credits"> Thiết kế bởi <a href="#">Nhóm Phát triển</a> </div>
</footer>

<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="assets/js/main.js"></script>
<script src="assets/js/auth.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>

    const API_URL = '/api/admin/customers';
    let allCustomers = [];
    let filteredCustomers = [];
    let currentPage = 1;
    const pageSize = 6;
    let currentDetailCustomerId = null;

    document.addEventListener('DOMContentLoaded', () => {
        fetchAllCustomers();
        setupEventListeners();
        toggleView('grid');
    });

    function toggleView(view) {
        // ... (Giữ nguyên hàm này) ...
        const gridView = document.getElementById('customerGridView');
        const listView = document.getElementById('customerListView');
        if (view === 'grid') {
            gridView.classList.remove('d-none');
            listView.classList.add('d-none');
        } else {
            gridView.classList.add('d-none');
            listView.classList.remove('d-none');
        }
    }

    async function fetchAllCustomers() {
        try {
            // <<< SỬA ĐỔI 2: Dùng fetchWithAuth >>>
            const response = await fetchWithAuth(API_URL);
            if (!response.ok) { throw new Error('Không thể tải danh sách khách hàng'); }
            const data = await response.json();
            allCustomers = data.map(c => {
                let level = 'bronze';
                if (c.loyaltyTierName) {
                    const nameLower = c.loyaltyTierName.toLowerCase();
                    if (nameLower.includes('silver')) level = 'silver';
                    else if (nameLower.includes('gold')) level = 'gold';
                    else if (nameLower.includes('platinum')) level = 'platinum';
                }
                return {
                    id: c.id, name: c.fullName, phone: c.phone, email: c.email, address: c.address, cccd: c.idNumber, dob: c.dateOfBirth,
                    level: level, points: c.currentPoints || 0, loyaltyBenefits: c.loyaltyBenefitsJson || '[]', loyaltyTierName: c.loyaltyTierName || 'Bronze',
                    bookings: c.bookings || 0, nights: c.nights || 0, spend: c.spend || 0,
                    type: c.type || 'regular',
                    lastBooking: c.createdAt ? new Date(c.createdAt).toLocaleDateString('vi-VN') : 'N/A',
                };
            });
            filteredCustomers = [...allCustomers];
            renderCustomers();
            updateStats();
        } catch (error) {
            if (error.message !== 'Phiên đăng nhập hết hạn') {
                console.error('Lỗi khi tải khách hàng:', error);
                document.getElementById('customerGridView').innerHTML = `<div class="alert alert-danger" role="alert"><strong>Lỗi:</strong> ${error.message}.</div>`;
            }
        }
    }

    function updateStats() {
        // ... (Giữ nguyên hàm này) ...
        const totalCustomers = allCustomers.length;
        const bronzeMembers = allCustomers.filter(c => c.level === 'bronze').length;
        const silverMembers = allCustomers.filter(c => c.level === 'silver').length;
        const goldMembers = allCustomers.filter(c => c.level === 'gold').length;
        const platinumMembers = allCustomers.filter(c => c.level === 'platinum').length;
        document.getElementById('statTotalCustomers').textContent = totalCustomers.toLocaleString();
        document.getElementById('statBronzeMembers').textContent = bronzeMembers.toLocaleString();
        document.getElementById('statSilverMembers').textContent = silverMembers.toLocaleString();
        document.getElementById('statGoldMembers').textContent = goldMembers.toLocaleString();
        document.getElementById('statPlatinumMembers').textContent = platinumMembers.toLocaleString();
    }

    function renderCustomers() {
        // ... (Giữ nguyên toàn bộ hàm renderCustomers) ...
        const grid = document.getElementById('customerGridView');
        const listBody = document.getElementById('customerListBody');
        const noResult = document.getElementById('noCustomerResult');
        const paginationEl = document.getElementById('customerPagination');
        grid.innerHTML = '';
        listBody.innerHTML = '';
        if (!filteredCustomers.length) {
            noResult.style.display = 'block';
            paginationEl.style.display = 'none';
            return;
        }
        noResult.style.display = 'none';
        paginationEl.style.display = '';
        const start = (currentPage - 1) * pageSize;
        const pageList = filteredCustomers.slice(start, start + pageSize);
        pageList.forEach(c => {
            const avatarText = c.name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
            const levelName = c.loyaltyTierName || 'Bronze';
            let formattedSpend = '0 VND';
            if (c.spend) {
                const spendNumber = Number(c.spend);
                if (!isNaN(spendNumber)) { formattedSpend = spendNumber.toLocaleString('vi-VN') + ' VND'; }
                else { formattedSpend = c.spend; }
            }
            grid.innerHTML += `
            <div class="col-xl-4 col-lg-6 mb-4">
                <div class="card customer-card h-100 ${c.type}" data-customer-id="${c.id}" data-type="${c.type}" data-level="${c.level}">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-3 pt-3">
                            <div class="d-flex align-items-center">
                                <div class="customer-avatar bg-primary me-3">${avatarText}</div>
                                <div>
                                    <h5 class="card-title mb-1">${c.name}</h5>
                                    <div class="d-flex align-items-center">
                                        <div class="loyalty-level level-${c.level} me-2" title="${levelName}">${levelName.charAt(0).toUpperCase()}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="customer-info mb-3">
                             <div class="row"> <div class="col-6"> <small class="text-muted">SĐT</small> <div>${c.phone || 'N/A'}</div> </div> <div class="col-6"> <small class="text-muted">Email</small> <div>${c.email || 'N/A'}</div> </div> </div>
                         </div>
                        <div class="customer-stats border-top pt-2 mt-2">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="fw-bold">${c.bookings || 0}</div>
                                    <small class="text-muted">Lần đặt</small>
                                </div>
                                <div class="col-4">
                                    <div class="fw-bold">${c.nights || 0}</div>
                                    <small class="text-muted">Đêm</small>
                                </div>
                                <div class="col-4">
                                    <div class="fw-bold">${formattedSpend}</div>
                                    <small class="text-muted">Tổng chi</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-auto pt-2">
                            <hr class="my-2">
                            <div class="d-flex justify-content-around btn-group">
                                <a class="btn btn-sm btn-outline-primary view-detail" href="#" data-id="${c.id}" data-bs-toggle="modal" data-bs-target="#customerDetailModal"> <i class="bi bi-eye"></i>  </a>
                                <a class="btn btn-sm btn-outline-warning edit-customer" href="#" data-id="${c.id}"> <i class="bi bi-pencil"></i>  </a>
                                <a class="btn btn-sm btn-outline-danger delete-customer" href="#" data-id="${c.id}"> <i class="bi bi-trash"></i>  </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
            const tableActionButtons = `
                <div class="btn-group">
                    <a class="btn btn-sm btn-outline-primary view-detail" href="#" data-id="${c.id}" data-bs-toggle="modal" data-bs-target="#customerDetailModal" title="Chi tiết"> <i class="bi bi-info-circle"></i> </a>
                    <a class="btn btn-sm btn-outline-warning edit-customer" href="#" data-id="${c.id}" title="Sửa"> <i class="bi bi-pencil"></i> </a>
                    <a class="btn btn-sm btn-outline-danger delete-customer" href="#" data-id="${c.id}" title="Xóa"> <i class="bi bi-trash"></i> </a>
                </div>
            `;
            listBody.innerHTML += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="customer-avatar bg-secondary me-3" style="width: 40px; height: 40px; font-size: 1rem;">${avatarText}</div>
                        <div>
                            <div class="fw-bold">${c.name}</div>
                            <small class="text-muted">${c.cccd || 'N/A'}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                         <div class="loyalty-level level-${c.level} me-2" title="${levelName}">${levelName.charAt(0).toUpperCase()}</div>
                         <div class="fw-bold text-primary">${(c.points || 0).toLocaleString()} điểm</div>
                    </div>
                </td>
                <td>
                    <div>${c.phone || 'N/A'}</div>
                    <small class="text-muted">${c.email || 'N/A'}</small>
                </td>
                <td>
                    <div>${c.bookings || 0} lần đặt / ${c.nights || 0} đêm</div>
                    <small class="fw-bold">${formattedSpend}</small>
                </td>
                <td>${tableActionButtons}</td>
            </tr>
            `;
        });
        renderPagination();
    }

    function renderPagination() {
        // ... (Giữ nguyên hàm này) ...
        const totalPages = Math.ceil(filteredCustomers.length / pageSize);
        const pag = document.querySelector('#customerPagination ul');
        pag.innerHTML = '';
        if (totalPages <= 1) return;
        pag.innerHTML += `<li class="page-item${currentPage === 1 ? ' disabled' : ''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage - 1})">Trước</a></li>`;
        for (let i = 1; i <= totalPages; i++) { pag.innerHTML += `<li class="page-item${i === currentPage ? ' active' : ''}"><a class="page-link" href="#" onclick="gotoPage(${i})">${i}</a></li>`; }
        pag.innerHTML += `<li class="page-item${currentPage === totalPages ? ' disabled' : ''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage + 1})">Tiếp</a></li>`;
    }

    function gotoPage(page) {
        // ... (Giữ nguyên hàm này) ...
        const totalPages = Math.ceil(filteredCustomers.length / pageSize);
        if (page < 1 || page > totalPages) return;
        currentPage = page; renderCustomers(); window.scrollTo(0, 0);
    }

    function filterCustomers() {
        // ... (Giữ nguyên hàm này) ...
        const q = document.getElementById('searchCustomer').value.trim().toLowerCase();
        const type = document.getElementById('filterType').value;
        const level = document.getElementById('filterLevel').value;
        filteredCustomers = allCustomers.filter(c => {
            let match = true;
            if (q) { match = (c.name.toLowerCase().includes(q) || (c.email && c.email.toLowerCase().includes(q)) || (c.phone && c.phone.includes(q))); }
            if (type) match = match && c.type === type;
            if (level) match = match && c.level === level;
            return match;
        });
        currentPage = 1; renderCustomers();
    }

    function showCustomerDetail(id) {
        // ... (Giữ nguyên hàm này) ...
        const c = allCustomers.find(x => x.id == id);
        if (!c) return;
        currentDetailCustomerId = id;
        document.getElementById('customerName').textContent = c.name;
        document.getElementById('detailName').textContent = c.name;
        document.getElementById('detailEmail').textContent = c.email || "Chưa có";
        document.getElementById('detailPhone').textContent = c.phone || "Chưa có";
        document.getElementById('detailCCCD').textContent = c.cccd;
        document.getElementById('detailDOB').textContent = c.dob ? new Date(c.dob).toLocaleDateString('vi-VN') : "Chưa có";
        document.getElementById('detailAddress').textContent = c.address || "Chưa có";
        const loyaltyInfoBody = document.getElementById('loyaltyInfoBody');
        const levelName = c.loyaltyTierName || 'Bronze';
        loyaltyInfoBody.innerHTML = `<h6 class="card-title">Thông tin thành viên</h6><div class="mb-3"><label class="form-label">Hạng thành viên</label><div class="fw-bold d-flex align-items-center"><div class="loyalty-level level-${c.level} me-2" title="${levelName}">${levelName.charAt(0).toUpperCase()}</div> ${levelName}</div></div><div class="mb-3"><label class="form-label">Điểm tích lũy</label><div class="fw-bold text-primary">${(c.points || 0).toLocaleString()} điểm</div></div><div class="mb-3"><label class="form-label">Quyền lợi</label><ul class="benefit-list ps-0"></ul></div>`;
        const benefitList = loyaltyInfoBody.querySelector('.benefit-list');
        try {
            const benefits = JSON.parse(c.loyaltyBenefits);
            if (benefits && benefits.length > 0) { benefitList.innerHTML = benefits.map(b => `<li><i class="bi bi-check-circle-fill text-success"></i> ${b}</li>`).join(''); } else { benefitList.innerHTML = '<li class="text-muted">Không có quyền lợi đặc biệt.</li>'; }
        } catch (e) { console.error("Lỗi parse JSON quyền lợi:", c.loyaltyBenefits, e); benefitList.innerHTML = '<li class="text-danger">Lỗi hiển thị quyền lợi.</li>'; }
        const bookingHistoryDiv = document.querySelector('#bookings .booking-history');
        const pointsHistoryDiv = document.querySelector('#loyalty .points-history');
        const loadingHtml = `<div class="text-center p-3 loading-indicator"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div> Đang tải lịch sử...</div>`;
        bookingHistoryDiv.innerHTML = loadingHtml; pointsHistoryDiv.innerHTML = loadingHtml;
        const firstTab = document.querySelector('#customerTabs button');
        if (firstTab) { new bootstrap.Tab(firstTab).show(); }
        const detailModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('customerDetailModal'));
        detailModal.show();
    }

    async function fetchBookingHistory(customerId) {
        const historyDiv = document.querySelector('#bookings .booking-history');
        const loadingIndicator = historyDiv.querySelector('.loading-indicator');
        if(loadingIndicator) loadingIndicator.style.display = 'block';
        try {
            // <<< SỬA ĐỔI 3: Dùng fetchWithAuth >>>
            const response = await fetchWithAuth(`${API_URL}/${customerId}/bookings`);
            if (!response.ok) { const error = await response.json().catch(() => ({ message: `Lỗi ${response.status}` })); throw new Error(error.message || 'Không thể tải lịch sử đặt phòng'); }
            const history = await response.json();
            historyDiv.innerHTML = '';
            if (history.length === 0) { historyDiv.innerHTML = '<p class="text-muted text-center p-3">Khách hàng chưa có đặt phòng nào.</p>'; return; }
            history.forEach(booking => {
                // ... (Giữ nguyên logic render) ...
                const checkIn = new Date(booking.checkInDate).toLocaleDateString('vi-VN');
                const checkOut = new Date(booking.checkOutDate).toLocaleDateString('vi-VN');
                let statusBadge = '';
                switch(booking.status) {
                    case 'CHECKED_OUT': statusBadge = '<span class="badge bg-success">Đã trả phòng</span>'; break;
                    case 'CANCELLED': statusBadge = '<span class="badge bg-danger">Đã hủy</span>'; break;
                    case 'CONFIRMED': statusBadge = '<span class="badge bg-info">Đã xác nhận</span>'; break;
                    case 'CHECKED_IN': statusBadge = '<span class="badge bg-primary">Đang ở</span>'; break;
                    default: statusBadge = `<span class="badge bg-secondary">${booking.status}</span>`;
                }
                historyDiv.innerHTML += `<div class="booking-history-item"><div class="d-flex justify-content-between align-items-center"><strong>${booking.bookingCode || 'N/A'} - ${booking.roomTypeName || 'N/A'} (${booking.roomNumber || 'N/A'})</strong>${statusBadge}</div><div>Từ ${checkIn} đến ${checkOut}</div><div class="text-muted">Tổng tiền: ${(booking.totalPrice || 0).toLocaleString()} VND</div></div>`;
            });
        } catch (error) {
            if (error.message !== 'Phiên đăng nhập hết hạn') {
                console.error('Lỗi tải lịch sử đặt phòng:', error);
                historyDiv.innerHTML = `<p class="text-center text-danger p-3">Lỗi: ${error.message}</p>`;
            }
        }
    }

    async function fetchPointsHistory(customerId) {
        const historyDiv = document.querySelector('#loyalty .points-history');
        const loadingIndicator = historyDiv.querySelector('.loading-indicator');
        if(loadingIndicator) loadingIndicator.style.display = 'block';
        try {
            // <<< SỬA ĐỔI 4: Dùng fetchWithAuth >>>
            const response = await fetchWithAuth(`${API_URL}/${customerId}/points-history`);
            if (!response.ok) { const error = await response.json().catch(() => ({ message: `Lỗi ${response.status}` })); throw new Error(error.message || 'Không thể tải lịch sử điểm'); }
            const history = await response.json();
            historyDiv.innerHTML = '';
            if (history.length === 0) { historyDiv.innerHTML = '<p class="text-muted text-center p-3">Chưa có giao dịch điểm nào.</p>'; return; }
            history.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            history.forEach(tx => {
                // ... (Giữ nguyên logic render) ...
                const date = new Date(tx.createdAt).toLocaleString('vi-VN');
                const pointsClass = tx.pointsEarned >= 0 ? 'text-success' : 'text-danger';
                const pointsPrefix = tx.pointsEarned >= 0 ? '+' : '';
                historyDiv.innerHTML += `<div class="d-flex justify-content-between align-items-center border-bottom pb-1 mb-1 points-history-item"><div><span class="text-muted">${date}</span><br>${tx.description || 'Giao dịch điểm'}</div><strong class="${pointsClass}">${pointsPrefix}${tx.pointsEarned.toLocaleString()}</strong></div>`;
            });
        } catch (error) {
            if (error.message !== 'Phiên đăng nhập hết hạn') {
                console.error('Lỗi tải lịch sử điểm:', error);
                historyDiv.innerHTML = `<p class="text-center text-danger p-3">Lỗi: ${error.message}</p>`;
            }
        }
    }

    function setupEventListeners() {
        // ... (Giữ nguyên logic event listener của tab) ...
        const customerDetailModalEl = document.getElementById('customerDetailModal');
        const bookingsTabTrigger = document.getElementById('bookings-tab');
        const loyaltyTabTrigger = document.getElementById('loyalty-tab');
        if (bookingsTabTrigger) { bookingsTabTrigger.addEventListener('shown.bs.tab', event => { if (currentDetailCustomerId) { const historyDiv = document.querySelector('#bookings .booking-history'); if (!historyDiv.querySelector('.booking-history-item') && !historyDiv.querySelector('.text-danger')) { fetchBookingHistory(currentDetailCustomerId); } } }); }
        if (loyaltyTabTrigger) { loyaltyTabTrigger.addEventListener('shown.bs.tab', event => { if (currentDetailCustomerId) { const historyDiv = document.querySelector('#loyalty .points-history'); if (!historyDiv.querySelector('.points-history-item') && !historyDiv.querySelector('.text-danger')) { fetchPointsHistory(currentDetailCustomerId); } } }); }
        customerDetailModalEl.addEventListener('hidden.bs.modal', event => {
            currentDetailCustomerId = null;
            const bookingHistoryDiv = document.querySelector('#bookings .booking-history');
            const pointsHistoryDiv = document.querySelector('#loyalty .points-history');
            const loadingHtml = `<div class="text-center p-3 loading-indicator"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div> Đang tải lịch sử...</div>`;
            if(bookingHistoryDiv) bookingHistoryDiv.innerHTML = loadingHtml;
            if(pointsHistoryDiv) pointsHistoryDiv.innerHTML = loadingHtml;
        });

        document.addEventListener('click', function (e) {
            // ... (Giữ nguyên logic event delegation) ...
            const viewBtn = e.target.closest('.view-detail');
            const editBtn = e.target.closest('.edit-customer');
            const deleteBtn = e.target.closest('.delete-customer');
            if (viewBtn) { e.preventDefault(); const id = viewBtn.getAttribute('data-id'); showCustomerDetail(id); }
            if (editBtn) { e.preventDefault(); const id = Number(editBtn.getAttribute('data-id')); populateEditModal(id); }
            if (deleteBtn) { e.preventDefault(); const id = Number(deleteBtn.getAttribute('data-id')); handleDeleteCustomer(id); }
        });

        // ... (Giữ nguyên logic filter/reset) ...
        document.getElementById('searchButton').onclick = filterCustomers;
        document.getElementById('searchCustomer').onkeydown = function (e) { if (e.key === 'Enter') filterCustomers(); };
        document.getElementById('resetFilters').onclick = function () { document.getElementById('searchCustomer').value = ''; document.getElementById('filterType').value = ''; document.getElementById('filterLevel').value = ''; filteredCustomers = [...allCustomers]; currentPage = 1; renderCustomers(); };

        // Nút Thêm khách hàng
        document.querySelector('#addCustomerModal .btn-primary').onclick = async function () {
            const modal = document.getElementById('addCustomerModal');
            const customerRequest = { fullName: document.getElementById('addFullName').value.trim(), phone: document.getElementById('addPhone').value.trim(), email: document.getElementById('addEmail').value.trim(), idNumber: document.getElementById('addIdNumber').value.trim(), dateOfBirth: document.getElementById('addDateOfBirth').value || null, address: document.getElementById('addAddress').value.trim() };
            if (!customerRequest.fullName || !customerRequest.phone || !customerRequest.idNumber) { alert("Vui lòng nhập đầy đủ Họ tên, SĐT và CCCD/CMND."); return; }
            try {
                // <<< SỬA ĐỔI 5: Dùng fetchWithAuth >>>
                const response = await fetchWithAuth(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(customerRequest) });
                if (!response.ok) { const error = await response.json().catch(() => ({ message: `Lỗi ${response.status}` })); throw new Error(error.message || 'Thêm khách hàng thất bại'); }
                bootstrap.Modal.getInstance(modal).hide(); document.getElementById('addCustomerForm').reset(); await fetchAllCustomers();
            } catch (error) {
                if (error.message !== 'Phiên đăng nhập hết hạn') {
                    console.error('Lỗi khi thêm khách hàng:', error);
                    alert(`Lỗi: ${error.message}`);
                }
            }
        };

        // Nút Sửa khách hàng
        document.getElementById('saveEditCustomer').onclick = async function () {
            const id = Number(document.getElementById('editCustomerId').value);
            const customerRequest = { fullName: document.getElementById('editName').value.trim(), phone: document.getElementById('editPhone').value.trim(), email: document.getElementById('editEmail').value.trim(), idNumber: document.getElementById('editCCCD').value.trim(), dateOfBirth: document.getElementById('editDOB').value || null, address: document.getElementById('editAddress').value.trim() };
            if (!customerRequest.fullName || !customerRequest.phone || !customerRequest.idNumber) { alert("Vui lòng nhập đầy đủ Họ tên, SĐT và CCCD/CMND."); return; }
            try {
                // <<< SỬA ĐỔI 6: Dùng fetchWithAuth >>>
                const response = await fetchWithAuth(`${API_URL}/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(customerRequest) });
                if (!response.ok) { const error = await response.json().catch(() => ({ message: `Lỗi ${response.status}` })); throw new Error(error.message || 'Cập nhật thất bại'); }
                bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide(); await fetchAllCustomers();
            } catch (error) {
                if (error.message !== 'Phiên đăng nhập hết hạn') {
                    console.error('Lỗi khi cập nhật:', error);
                    alert(`Lỗi: ${error.message}`);
                }
            }
        };

        // ... (Giữ nguyên logic export) ...
        document.getElementById('exportCustomers').onclick = function () {
            const dataToExport = filteredCustomers.map(c => ({ 'Tên Khách Hàng': c.name, 'Số Điện Thoại': c.phone, 'Email': c.email, 'CCCD/CMND': c.cccd, 'Ngày Sinh': c.dob ? new Date(c.dob).toLocaleDateString('vi-VN') : '', 'Địa Chỉ': c.address, 'Hạng': c.loyaltyTierName || 'Bronze', 'Điểm': c.points || 0 }));
            if (dataToExport.length === 0) { alert("Không có dữ liệu để xuất."); return; }
            const worksheet = XLSX.utils.json_to_sheet(dataToExport); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "DanhSachKhachHang");
            const cols = Object.keys(dataToExport[0] || {}); const colWidths = cols.map(key => { const headerWidth = key.length; const dataWidths = dataToExport.map(row => String(row[key] || '').length); return { wch: Math.max(headerWidth, ...dataWidths) + 2 }; }); worksheet['!cols'] = colWidths;
            XLSX.writeFile(workbook, "DanhSachKhachHang.xlsx");
        };

        // ... (Giữ nguyên logic modal hidden) ...
        const addModal = document.getElementById('addCustomerModal'); const editModal = document.getElementById('editCustomerModal'); addModal.addEventListener('hidden.bs.modal', () => document.getElementById('addCustomerForm').reset()); editModal.addEventListener('hidden.bs.modal', () => document.getElementById('editCustomerForm').reset());
        document.getElementById('customerGridViewBtn').addEventListener('click', () => toggleView('grid'));
        document.getElementById('customerListViewBtn').addEventListener('click', () => toggleView('list'));
    }

    function populateEditModal(id) {
        // ... (Giữ nguyên hàm này) ...
        const c = allCustomers.find(x => x.id === id);
        if (!c) return;
        document.getElementById('editCustomerId').value = c.id;
        document.getElementById('editName').value = c.name;
        document.getElementById('editPhone').value = c.phone || '';
        document.getElementById('editEmail').value = c.email || '';
        document.getElementById('editCCCD').value = c.cccd;
        document.getElementById('editDOB').value = c.dob || '';
        document.getElementById('editAddress').value = c.address || '';
        new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
    }

    async function handleDeleteCustomer(id) {
        if (!confirm('Bạn có chắc muốn xóa khách hàng này? Hành động này không thể hoàn tác.')) { return; }
        try {
            // <<< SỬA ĐỔI 7: Dùng fetchWithAuth >>>
            const response = await fetchWithAuth(`${API_URL}/${id}`, { method: 'DELETE' });
            if (!response.ok) { try { const error = await response.json(); throw new Error(error.message || 'Xóa thất bại'); } catch (jsonError) { throw new Error('Xóa thất bại. Có thể khách hàng đang có đặt phòng liên quan.'); } }
            alert('Đã xóa khách hàng thành công.'); await fetchAllCustomers();
        } catch (error) {
            if (error.message !== 'Phiên đăng nhập hết hạn') {
                console.error('Lỗi khi xóa:', error);
                alert(`Lỗi: ${error.message}`);
            }
        }
    }
</script>
</body>
</html>

