<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Tất cả đặt phòng - HotelAdmin</title>

    <link href="assets/img/img.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

    <link href="assets/css/style.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .status-badge {
            font-size: 0.75rem;
            padding: 0.35em 0.65em;
        }
        .booking-card {
            transition: all 0.3s ease;
            border-left: 4px solid #4154f1;
        }
        .booking-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .booking-card.pending {
            border-left-color: #ffc107;
        }
        .booking-card.confirmed {
            border-left-color: #198754;
        }
        .booking-card.checked-in {
            border-left-color: #0dcaf0;
        }
        .booking-card.checked-out {
            border-left-color: #6c757d;
        }
        .booking-card.cancelled {
            border-left-color: #dc3545;
        }
        .filter-active {
            background-color: #4154f1 !important;
            color: white !important;
        }
    </style>
</head>
<body>

<header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
        <a href="index.html" class="logo d-flex align-items-center">
            <img src="assets/img/logo.png" alt="Logo">
            <span class="d-none d-lg-block">Grandoria</span>
        </a>
        <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><div class="search-bar">
    <form class="search-form d-flex align-items-center" method="POST" action="#">
        <input type="text" name="query" placeholder="Tìm kiếm đặt phòng, khách hàng..." title="Nhập từ khóa tìm kiếm">
        <button type="submit" title="Tìm kiếm"><i class="bi bi-search"></i></button>
    </form>
</div><nav class="header-nav ms-auto">
    <ul class="d-flex align-items-center">

        <li class="nav-item d-block d-lg-none">
            <a class="nav-link nav-icon search-bar-toggle " href="#">
                <i class="bi bi-search"></i>
            </a>
        </li><li class="nav-item dropdown">
        <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-bell"></i>
            <span class="badge bg-primary badge-number">3</span>
        </a><ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications">
        <li class="dropdown-header">
            Bạn có 3 thông báo mới
            <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">Xem tất cả</span></a>
        </li>
        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-exclamation-circle text-warning"></i>
            <div>
                <h4>Đặt phòng mới</h4>
                <p>Khách hàng Nguyễn Văn A vừa đặt phòng Deluxe</p>
                <p>5 phút trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-x-circle text-danger"></i>
            <div>
                <h4>Hủy đặt phòng</h4>
                <p>Đặt phòng #2457 đã bị hủy</p>
                <p>2 giờ trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-check-circle text-success"></i>
            <div>
                <h4>Phản hồi mới</h4>
                <p>Bạn có 2 đánh giá mới từ khách hàng</p>
                <p>4 giờ trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>
        <li class="dropdown-footer">
            <a href="#">Hiển thị tất cả thông báo</a>
        </li>
    </ul></li><li class="nav-item dropdown pe-3">

        <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <img src="assets/img/profile-img.jpg" alt="Hồ sơ" class="rounded-circle">
            <span class="d-none d-md-block dropdown-toggle ps-2" id="profileName">Đang tải...</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li class="dropdown-header">
                <h6 id="profileDropdownName">...</h6>
                <span id="profileDropdownRole">...</span>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                    <i class="bi bi-person"></i>
                    <span>Hồ sơ của tôi</span>
                </a>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                    <i class="bi bi-gear"></i>
                    <span>Cài đặt tài khoản</span>
                </a>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="#" id="logoutButton">
                    <i class="bi bi-box-arrow-right"></i>
                    <span>Đăng xuất</span>
                </a>
            </li>
        </ul></li></ul>
</nav></header><aside id="sidebar" class="sidebar">

    <ul class="sidebar-nav" id="sidebar-nav">

        <li class="nav-item">
            <a class="nav-link " href="index.html">
                <i class="bi bi-house-door"></i>
                <span>Bảng Điều Khiển</span>
            </a>
        </li><li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#booking-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-calendar-check"></i><span>Quản lý Đặt phòng</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="booking-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
            <li>
                <a href="tatcadatphong.html">
                    <i class="bi bi-circle"></i><span>Tất cả đặt phòng</span>
                </a>
            </li>
            <li>
                <a href="checkin.html">
                    <i class="bi bi-circle"></i><span>Check-in</span>
                </a>
            </li>
            <li>
                <a href="checkout.html">
                    <i class="bi bi-circle"></i><span>Check-out</span>
                </a>
            </li>
        </ul>
    </li><li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#room-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-door-closed"></i><span>Quản lý Phòng</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="room-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
            <li>
                <a href="danhsachphong.html">
                    <i class="bi bi-circle"></i><span>Danh sách phòng</span>
                </a>
            </li>
            <li>
                <a href="loaiphong.html">
                    <i class="bi bi-circle"></i><span>Loại phòng</span>
                </a>
            </li>
            <li>
                <a href="tinhtrangphong.html">
                    <i class="bi bi-circle"></i><span>Tình trạng phòng</span>
                </a>
            </li>
            <li>
                <a href="giaphong.html">
                    <i class="bi bi-circle"></i><span>Giá phòng</span>
                </a>
            </li>
        </ul>
    </li><li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#customer-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-people"></i><span>Quản lý Khách hàng</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="customer-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
            <li>
                <a href="danhsachkhachhang.html">
                    <i class="bi bi-circle"></i><span>Danh sách khách hàng</span>
                </a>
            </li>
            <li>
                <a href="chuongtrinhthanhvien.html">
                    <i class="bi bi-circle"></i><span>Chương trình thành viên</span>
                </a>
            </li>
            <li>
                <a href="danhgia&phanhoi.html">
                    <i class="bi bi-circle"></i><span>Đánh giá & Phản hồi</span>
                </a>
            </li>
        </ul>
    </li><li class="nav-item">
        <a class="nav-link collapsed" href="baocao&thongke.html">
            <i class="bi bi-bar-chart"></i>
            <span>Báo cáo & Thống kê</span>
        </a>
    </li><li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#finance-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-cash-coin"></i><span>Tài chính</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="finance-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
            <li>
                <a href="finance-invoices.html">
                    <i class="bi bi-circle"></i><span>Hóa đơn</span>
                </a>
            </li>
            <li>
                <a href="finance-payments.html">
                    <i class="bi bi-circle"></i><span>Thanh toán</span>
                </a>
            </li>
            <li>
                <a href="finance-revenue.html">
                    <i class="bi bi-circle"></i><span>Doanh thu</span>
                </a>
            </li>
        </ul>
    </li><li class="nav-heading">Trang</li>

        <li class="nav-item">
            <a class="nav-link collapsed" href="users-profile.html">
                <i class="bi bi-person"></i>
                <span>Hồ sơ</span>
            </a>
        </li><li class="nav-item">
        <a class="nav-link collapsed" href="pages-contact.html">
            <i class="bi bi-envelope"></i>
            <span>Liên hệ</span>
        </a>
    </li><li class="nav-item">
        <a class="nav-link collapsed" href="users.html">
            <i class="bi bi-person-gear"></i>
            <span>Nhân viên</span>
        </a>
    </li>

        <li class="nav-item">
            <a class="nav-link collapsed" href="taikhoan.html">
                <i class="bi bi-person-badge"></i>
                <span>Tài khoản</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" href="settings.html">
                <i class="bi bi-gear"></i>
                <span>Cài đặt</span>
            </a>
        </li>
    </ul>

</aside>
<main id="main" class="main">
    <div class="pagetitle d-flex justify-content-between align-items-center">
        <h1>Tất cả đặt phòng</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
                <li class="breadcrumb-item">Quản lý Đặt phòng</li>
                <li class="breadcrumb-item active">Tất cả đặt phòng</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title">Danh sách Đặt phòng</h5>
                            <div>
                                <div class="btn-group me-2" role="group" aria-label="View toggle">
                                    <input type="radio" class="btn-check" name="viewMode" id="gridView" checked>
                                    <label class="btn btn-outline-primary" for="gridView" title="Xem lưới">
                                        <i class="bi bi-grid-3x3-gap"></i>
                                    </label>
                                    <input type="radio" class="btn-check" name="viewMode" id="listView">
                                    <label class="btn btn-outline-primary" for="listView" title="Xem danh sách">
                                        <i class="bi bi-list-ul"></i>
                                    </label>
                                </div>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookingModal">
                                    <i class="bi bi-plus-circle"></i> Thêm đặt phòng
                                </button>
                                <button class="btn btn-outline-secondary" id="btnExportExcel">
                                    <i class="bi bi-download"></i> Xuất Excel
                                </button>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="btn-group" role="group" id="statusFilterGroup">
                                    <input type="radio" class="btn-check" name="btnradio" id="btnradio1" checked value="">
                                    <label class="btn btn-outline-primary" for="btnradio1">Tất cả</label>
                                    <input type="radio" class="btn-check" name="btnradio" id="btnradio2" value="pending">
                                    <label class="btn btn-outline-primary" for="btnradio2">Đang chờ</label>
                                    <input type="radio" class="btn-check" name="btnradio" id="btnradio3" value="confirmed">
                                    <label class="btn btn-outline-primary" for="btnradio3">Đã xác nhận</label>
                                    <input type="radio" class="btn-check" name="btnradio" id="btnradio4" value="checked-in">
                                    <label class="btn btn-outline-primary" for="btnradio4">Đã check-in</label>
                                    <input type="radio" class="btn-check" name="btnradio" id="btnradio5" value="checked-out">
                                    <label class="btn btn-outline-primary" for="btnradio5">Đã check-out</label>
                                    <input type="radio" class="btn-check" name="btnradio" id="btnradio6" value="cancelled">
                                    <label class="btn btn-outline-primary" for="btnradio6">Đã hủy</label>
                                </div> <button class="btn btn-outline-danger" id="btnShowTrash">
                                <i class="bi bi-trash"></i> Thùng Rác</button>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label class="form-label">Từ ngày</label>
                            <input type="date" class="form-control" id="filterFromDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Đến ngày</label>
                            <input type="date" class="form-control" id="filterToDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Loại phòng</label>
                            <select class="form-select" id="filterRoomType">
                                <option value="">Tất cả</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tìm kiếm</label>
                            <input type="text" class="form-control mb-2" id="filterSearch" placeholder="Tên, SĐT, mã đặt phòng...">
                            <button class="btn btn-primary w-100" id="btnApplyFilter">Áp dụng</button>
                        </div>
                    </div>

                    <div class="row" id="bookingGridView">
                    </div>

                    <div class="table-responsive d-none" id="bookingListView">
                        <table class="table table-hover align-middle">
                            <thead>
                            <tr>
                                <th scope="col">Mã Đặt Phòng</th>
                                <th scope="col">Khách hàng</th>
                                <th scope="col">Phòng & Thời gian</th>
                                <th scope="col">Ngày nhận/trả</th>
                                <th scope="col">Tổng tiền</th>
                                <th scope="col">Trạng thái</th>
                                <th scope="col" style="min-width: 150px;">Thao tác</th>
                            </tr>
                            </thead>
                            <tbody id="bookingListBody">
                            </tbody>
                        </table>
                    </div>

                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="pagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        </div>
    </section>
</main>
<div class="modal fade" id="addBookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalTitle">Thêm đặt phòng mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Khách hàng</label>
                                <select class="form-select" id="inputCustomerSelect" required>
                                    <option value="">-- Chọn khách hàng --</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Số điện thoại</label>
                                <input type="text" class="form-control" id="inputPhone" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inputRoomId" class="form-label">Phòng</label>
                                <select class="form-select" id="inputRoomId" required>
                                    <option value="">Chọn phòng...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inputTotal" class="form-label">Tổng tiền (VND)</label>
                                <input type="number" class="form-control" id="inputTotal" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ngày nhận phòng</label>
                                <input type="date" class="form-control" id="inputCheckin" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ngày trả phòng</label>
                                <input type="date" class="form-control" id="inputCheckout" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inputSoNguoiLon" class="form-label">Số người lớn</label>
                                <input type="number" class="form-control" id="inputSoNguoiLon" value="1" min="1" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inputSoTreEm" class="form-label">Số trẻ em</label>
                                <input type="number" class="form-control" id="inputSoTreEm" value="0" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="row d-none" id="statusRow">
                        <hr class="my-2">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="inputStatus" class="form-label">Trạng thái</label>
                                <select class="form-select" id="inputStatus">
                                    <option value="pending">Đang chờ</option>
                                    <option value="confirmed">Đã xác nhận</option>
                                    <option value="checked-in">Đã check-in</option>
                                    <option value="checked-out">Đã check-out</option>
                                    <option value="cancelled">Đã hủy</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="btnSaveBooking">Lưu đặt phòng</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="detailBookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết đặt phòng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailBookingBody">
            </div>
        </div>
    </div>
</div>
<footer id="footer" class="footer">
    <div class="copyright">
        &copy; Bản quyền <strong><span>HotelAdmin</span></strong>. Tất cả các quyền được bảo lưu
    </div>
    <div class="credits">
        Thiết kế bởi <a href="#">Nhóm Phát triển</a>
    </div>
</footer>

<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="assets/js/main.js"></script>
<script src="assets/js/auth.js"></script>

<script>
    const API_URL = 'http://localhost:8080/api/admin';
    const TOKEN = localStorage.getItem('jwtToken'); // Giả sử token được lưu ở đây sau khi đăng nhập

    // State quản lý bộ lọc và phân trang
    let currentFilters = {
        page: 0,
        size: 12,
        sort: 'createdDate,desc',
        status: '',
        fromDate: '',
        toDate: '',
        roomTypeId: '',
        search: ''
    };
    let editBookingId = null;
    let originalBookingStatus = null; // Biến mới để lưu trạng thái gốc khi sửa

    // === ⭐ 1. HÀM TIỆN ÍCH MỚI ===
    // Hàm này dùng để Bật/Tắt các bộ lọc (ngày, loại phòng, tìm kiếm)
    function toggleFilterControls(enabled) {
        document.getElementById('filterFromDate').disabled = !enabled;
        document.getElementById('filterToDate').disabled = !enabled;
        document.getElementById('filterRoomType').disabled = !enabled;
        document.getElementById('filterSearch').disabled = !enabled;
        document.getElementById('btnApplyFilter').disabled = !enabled;
    }

    // THÊM MỚI: Hàm chuyển đổi chế độ xem Lưới/Danh sách
    function toggleView(view) {
        const gridView = document.getElementById('bookingGridView');
        const listView = document.getElementById('bookingListView');

        if (view === 'grid') {
            gridView.classList.remove('d-none');
            listView.classList.add('d-none');
        } else {
            gridView.classList.add('d-none');
            listView.classList.remove('d-none');
        }
    }

    // === ⭐ 2. HÀM "NÃO BỘ" ĐÃ CẬP NHẬT (XỬ LÝ THÙNG RÁC) ===
    async function fetchAndRenderBookings() {
        const params = new URLSearchParams();
        params.append('page', currentFilters.page);
        params.append('size', currentFilters.size);
        params.append('sort', currentFilters.sort);

        let endpoint = `${API_URL}/bookings`; // API mặc định

        // --- Logic mới để kiểm tra Thùng Rác ---
        if (currentFilters.status === 'trash') {
            // Nếu là thùng rác, gọi API riêng và tắt bộ lọc
            endpoint = `${API_URL}/bookings/trash`;
            toggleFilterControls(false); // Vô hiệu hóa các bộ lọc khác
        } else {
            // Nếu là bộ lọc bình thường, thêm các tham số lọc
            if (currentFilters.status) params.append('status', currentFilters.status);
            if (currentFilters.fromDate) params.append('fromDate', currentFilters.fromDate);
            if (currentFilters.toDate) params.append('toDate', currentFilters.toDate);
            if (currentFilters.roomTypeId) params.append('roomTypeId', currentFilters.roomTypeId);
            if (currentFilters.search) params.append('search', currentFilters.search);
            toggleFilterControls(true); // Bật các bộ lọc
        }
        // --- Kết thúc logic mới ---

        try {
            // Dùng biến "endpoint" đã được xác định
            const response = await fetch(`${endpoint}?${params.toString()}`, {
                headers: {
                    'Authorization': `Bearer ${TOKEN}`
                }
            });

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('jwtToken');
                    alert('Phiên đăng nhập không hợp lệ hoặc đã hết hạn. Vui lòng đăng nhập lại.');
                    window.location.href = 'pages-login.html';
                }
                throw new Error('Lỗi khi tải dữ liệu đặt phòng.');
            }
            const pageData = await response.json();
            renderBookings(pageData.content);
            renderPagination(pageData);
        } catch (error) {
            console.error('Error fetching bookings:', error);
            document.getElementById('bookingGridView').innerHTML = `<div class="col-12"><p class="text-center text-danger">${error.message}</p></div>`;
        }
    }


    // CẬP NHẬT: Hiển thị danh sách đặt phòng (cho cả Lưới và Danh sách)
    function renderBookings(bookings) {
        const grid = document.getElementById('bookingGridView');
        const listBody = document.getElementById('bookingListBody');

        // Xóa nội dung cũ
        grid.innerHTML = '';
        listBody.innerHTML = '';

        if (!bookings || bookings.length === 0) {
            // === LOGIC MỚI: Hiển thị thông báo thùng rác trống ===
            let emptyMessage = (currentFilters.status === 'trash')
                ? 'Thùng rác trống.'
                : 'Không tìm thấy đặt phòng nào.';
            grid.innerHTML = `<div class="col-12"><p class="text-center text-muted">${emptyMessage}</p></div>`;
            listBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">${emptyMessage}</td></tr>`;
            return;
        }

        bookings.forEach(b => {
            // Dữ liệu chung
            const statusText = {
                'pending': "Đang chờ", 'confirmed': "Đã xác nhận", 'checked-in': "Đã check-in",
                'checked-out': "Đã check-out", 'cancelled': "Đã hủy"
            }[b.status] || b.status;
            const statusBadge = {
                'pending': "warning", 'confirmed': "success", 'checked-in': "info",
                'checked-out': "secondary", 'cancelled': "danger"
            }[b.status] || "primary";

            // === LOGIC MỚI: Xử lý nút thao tác cho thùng rác ===
            // Ẩn tất cả các nút khi ở trong thùng rác
            const isTrashView = currentFilters.status === 'trash';

            const gridActionButtons = isTrashView ? '' : `
                <div class="btn-group w-100">
                    <button class="btn btn-sm btn-outline-primary" onclick="showBookingDetail(${b.id})"><i class="bi bi-eye"></i></button>
                    <button class="btn btn-sm btn-outline-warning" onclick="editBooking(${b.id})"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteBooking(${b.id})"><i class="bi bi-trash"></i></button>
                    ${b.status === "pending" ? `<button class="btn btn-sm btn-outline-success" onclick="updateBookingStatus(${b.id}, 'confirmed')"><i class="bi bi-check-circle"></i></button>` : ""}
                    ${b.status === "confirmed" ? `<button class="btn btn-sm btn-outline-info" onclick="updateBookingStatus(${b.id}, 'checked-in')"><i class="bi bi-check-circle"></i></button>` : ""}
                    ${b.status === "checked-in" ? `<button class="btn btn-sm btn-outline-secondary" onclick="updateBookingStatus(${b.id}, 'checked-out')"><i class="bi bi-box-arrow-right"></i></button>` : ""}
                </div>
                ${(b.status === "pending" || b.status === "confirmed") ? `
                <button class="btn btn-sm btn-danger w-100 mt-2" onclick="cancelBooking(${b.id})"><i class="bi bi-x-circle"></i> Hủy đặt phòng</button>
                ` : ""}`;

            const tableActionButtons = isTrashView ? '' : `
                <div class="btn-group w-100">
                    <button class="btn btn-sm btn-outline-primary" onclick="showBookingDetail(${b.id})" title="Xem"><i class="bi bi-eye"></i></button>
                    <button class="btn btn-sm btn-outline-warning" onclick="editBooking(${b.id})" title="Sửa"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteBooking(${b.id})" title="Xóa"><i class="bi bi-trash"></i></button>
                    ${b.status === "pending" ? `<button class="btn btn-sm btn-outline-success" onclick="updateBookingStatus(${b.id}, 'confirmed')" title="Xác nhận"><i class="bi bi-check-circle"></i></button>` : ""}
                    ${b.status === "confirmed" ? `<button class="btn btn-sm btn-outline-info" onclick="updateBookingStatus(${b.id}, 'checked-in')" title="Check-in"><i class="bi bi-check-circle"></i></button>` : ""}
                    ${b.status === "checked-in" ? `<button class="btn btn-sm btn-outline-secondary" onclick="updateBookingStatus(${b.id}, 'checked-out')" title="Check-out"><i class="bi bi-box-arrow-right"></i></button>` : ""}
                </div>
                ${(b.status === "pending" || b.status === "confirmed") ? `
                <button class="btn btn-sm btn-danger w-100 mt-2" onclick="cancelBooking(${b.id})"><i class="bi bi-x-circle"></i> Hủy</button>
                ` : ""}`;
            // === KẾT THÚC LOGIC MỚI ===

            // --- 1. Render Chế độ Lưới (Grid View) ---
            grid.innerHTML += `
            <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                <div class="card booking-card ${b.status} h-100">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="card-title mb-1">${b.code}</h6>
                            </div>
                            <span class="badge bg-${statusBadge} status-badge">${statusText}</span>
                        </div>
                        <div class="customer-info mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="customer-avatar bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                    <span class="text-white fw-bold">${getInitials(b.customer)}</span>
                                </div>
                                <div>
                                    <div class="fw-bold">${b.customer}</div>

                                </div>
                            </div>
                        </div>
                        <div class="booking-info">
                            <div class="row">
                                <div class="col-12"><div class="fw-bold">${b.roomType} ${b.roomNumber}</div></div>

                            </div>
                            <div class="row mt-2">
                                <div class="col-6"><small class="text-muted">Nhận phòng</small><div>${formatDate(b.checkin)}</div></div>
                                <div class="col-6"><small class="text-muted">Trả phòng</small><div>${formatDate(b.checkout)}</div></div>
                            </div>

                        </div>

                        <div class="booking-actions mt-auto pt-3">
                            ${gridActionButtons}
                        </div>
                    </div>
                </div>
            </div>`;

            // --- 2. Render Chế độ Danh sách (List View) ---
            listBody.innerHTML += `
                <tr>
                    <td>
                        <strong>${b.code}</strong><br>
                        <small class="text-muted">${b.created}</small>
                    </td>
                    <td>
                        <div class="fw-bold">${b.customer}</div>
                        <small class="text-muted">${b.phone}</small>
                    </td>
                    <td>
                        <div class="fw-bold">${b.roomType} ${b.roomNumber}</div>
                        <small class="text-muted">${b.nights} đêm</small>
                    </td>
                    <td>
                        <div>Nhận: ${formatDate(b.checkin)}</div>
                        <div>Trả: ${formatDate(b.checkout)}</div>
                    </td>
                    <td class="text-nowrap"><strong>${(b.total || 0).toLocaleString()} VND</strong></td>
                    <td><span class="badge bg-${statusBadge} status-badge">${statusText}</span></td>
                    <td>${tableActionButtons}</td>
                </tr>
            `;
        });
    }


    // Hiển thị phân trang
    function renderPagination(page) {
        const pag = document.getElementById('pagination');
        pag.innerHTML = '';
        if (page.totalPages <= 1) return;

        pag.innerHTML += `<li class="page-item${page.first ? ' disabled' : ''}">
            <a class="page-link" href="#" onclick="gotoPage(${page.number - 1})">Trước</a></li>`;
        for (let i = 0; i < page.totalPages; i++) {
            pag.innerHTML += `<li class="page-item${i === page.number ? ' active' : ''}">
                <a class="page-link" href="#" onclick="gotoPage(${i})">${i + 1}</a></li>`;
        }
        pag.innerHTML += `<li class="page-item${page.last ? ' disabled' : ''}">
            <a class="page-link" href="#" onclick="gotoPage(${page.number + 1})">Tiếp</a></li>`;
    }

    function gotoPage(pageNumber) {
        currentFilters.page = pageNumber;
        fetchAndRenderBookings();
    }

    // === ⭐ 3. HÀM `applyFilters` ĐÃ CẬP NHẬT ===
    // (Hàm này giờ CHỈ xử lý nút "Áp dụng" cho ngày/loại phòng/tìm kiếm)
    function applyFilters() {
        // currentFilters.status = ... // <-- XÓA DÒNG NÀY
        currentFilters.fromDate = document.getElementById('filterFromDate').value;
        currentFilters.toDate = document.getElementById('filterToDate').value;
        currentFilters.roomTypeId = document.getElementById('filterRoomType').value;
        currentFilters.search = document.getElementById('filterSearch').value.trim();
        currentFilters.page = 0; // Reset về trang đầu khi lọc
        fetchAndRenderBookings();
    }


    // === CÁC HÀM ĐÃ CẬP NHẬT (SỬA LỖI CUSTOMER ID) ===

    // Thêm/Sửa đặt phòng
    async function saveBooking() {
        const form = document.getElementById('bookingForm');

        // Lấy dữ liệu từ dropdown khách hàng
        const customerSelect = document.getElementById('inputCustomerSelect');
        const selectedOption = customerSelect.options[customerSelect.selectedIndex];

        const bookingData = {
            // Gửi customerId lên backend
            customerId: customerSelect.value,

            // Vẫn gửi kèm tên và sđt (vì DTO của bạn có)
            customer: selectedOption.dataset.name || selectedOption.text.split(' (')[0],
            phone: document.getElementById('inputPhone').value.trim(),

            // Các trường còn lại
            roomId: document.getElementById('inputRoomId').value,
            checkin: document.getElementById('inputCheckin').value,
            checkout: document.getElementById('inputCheckout').value,
            total: parseFloat(document.getElementById('inputTotal').value) || 0,

            // === BẮT ĐẦU SỬA ĐỔI ===
            soNguoiLon: parseInt(document.getElementById('inputSoNguoiLon').value) || 1,
            soTreEm: parseInt(document.getElementById('inputSoTreEm').value) || 0
            // === KẾT THÚC SỬA ĐỔI ===
        };

        if (!bookingData.customerId || !bookingData.roomId || !bookingData.checkin || !bookingData.checkout) {
            alert("Vui lòng chọn khách hàng, phòng và ngày.");
            return;
        }

        const method = editBookingId ? 'PUT' : 'POST';
        const url = editBookingId ? `${API_URL}/bookings/${editBookingId}` : `${API_URL}/bookings`;
        let statusChanged = false; // Biến kiểm tra thay đổi trạng thái

        try {
            // Bước 1: Luôn lưu thông tin chính (PUT/POST)
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` },
                body: JSON.stringify(bookingData)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || (editBookingId ? 'Lỗi khi cập nhật thông tin.' : 'Lỗi khi tạo đặt phòng.'));
            }

            // Bước 2: Nếu là CHỈNH SỬA, kiểm tra và cập nhật trạng thái
            if (editBookingId) {
                const newStatus = document.getElementById('inputStatus').value;
                if (newStatus !== originalBookingStatus) { // Chỉ gọi API nếu trạng thái thay đổi
                    await updateBookingStatus(editBookingId, newStatus, true); // true = gọi từ bên trong
                    statusChanged = true;
                }
            }

            alert(editBookingId ? `Cập nhật thông tin ${statusChanged ? 'và trạng thái' : ''} thành công!` : 'Tạo đặt phòng thành công!');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('addBookingModal')).hide();
            fetchAndRenderBookings(); // Tải lại danh sách
        } catch (error) {
            console.error('Error saving booking:', error);
            alert(error.message);
        }
    }

    // Mở modal để sửa
    async function editBooking(id) {
        try {
            const response = await fetch(`${API_URL}/bookings/${id}`, { headers: { 'Authorization': `Bearer ${TOKEN}` } });
            if (!response.ok) throw new Error('Không tìm thấy thông tin đặt phòng.');
            const b = await response.json(); // b là BookingDto

            editBookingId = id;
            originalBookingStatus = b.status; // Lưu trạng thái gốc
            document.getElementById('bookingModalTitle').textContent = "Chỉnh sửa đặt phòng";

            // Không set 'inputCustomer' (text) nữa
            document.getElementById('inputPhone').value = b.phone;
            document.getElementById('inputCheckin').value = b.checkin;
            document.getElementById('inputCheckout').value = b.checkout;
            document.getElementById('inputTotal').value = b.total;

            // === BẮT ĐẦU SỬA ĐỔI ===
            document.getElementById('inputSoNguoiLon').value = b.soNguoiLon;
            document.getElementById('inputSoTreEm').value = b.soTreEm;
            // === KẾT THÚC SỬA ĐỔI ===

            // Hiển thị và cài đặt trường trạng thái
            document.getElementById('statusRow').classList.remove('d-none');
            document.getElementById('inputStatus').value = b.status;

            // Tải và chọn đúng khách hàng, phòng
            await loadRoomsIntoModal(b.roomId);
            await loadCustomersIntoModal(b.customerId); // Dùng customerId từ DTO

            new bootstrap.Modal(document.getElementById('addBookingModal')).show();
        } catch (error) {
            alert(error.message);
        }
    }

    // Nút mở modal Thêm mới
    document.querySelector('[data-bs-target="#addBookingModal"]').onclick = function() {
        editBookingId = null;
        originalBookingStatus = null; // Reset trạng thái gốc
        document.getElementById('bookingModalTitle').textContent = "Thêm đặt phòng mới";
        document.getElementById('bookingForm').reset();

        // Ẩn hàng trạng thái đi khi thêm mới
        document.getElementById('statusRow').classList.add('d-none');

        // Tải cả 2 danh sách
        loadRoomsIntoModal();
        loadCustomersIntoModal(); // Tải khách hàng
    };

    // === HÀM MỚI ĐỂ TẢI KHÁCH HÀNG ===
    async function loadCustomersIntoModal(selectedCustomerId = null) {
        const select = document.getElementById('inputCustomerSelect');
        select.innerHTML = '<option value="">-- Đang tải... --</option>';
        try {
            // Gọi API /api/admin/customers
            const response = await fetch(`${API_URL}/customers`, {
                headers: { 'Authorization': `Bearer ${TOKEN}` }
            });
            if (!response.ok) throw new Error('Lỗi tải danh sách khách hàng');

            const customers = await response.json(); // Giả sử API này trả về List, không phải Page

            select.innerHTML = '<option value="">-- Chọn khách hàng --</option>';
            customers.forEach(c => {
                const isSelected = c.id == selectedCustomerId;
                select.innerHTML += `<option
                                        value="${c.id}"
                                        data-phone="${c.phone || ''}"
                                        data-name="${c.fullName || ''}"
                                        ${isSelected ? 'selected' : ''}>
                                        ${c.fullName} (${c.email || 'N/A'})
                                     </option>`;
            });
        } catch (error) {
            console.error(error);
            select.innerHTML = '<option value="">Lỗi tải khách hàng</option>';
        }
    }

    // Thêm sự kiện tự điền SĐT
    document.getElementById('inputCustomerSelect').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const phone = selectedOption.dataset.phone || '';
        document.getElementById('inputPhone').value = phone;
    });

    // === CÁC HÀM KHÁC (KHÔNG THAY ĐỔI) ===

    // Xóa đặt phòng
    async function deleteBooking(id) {
        if (confirm("Bạn có chắc muốn xóa đặt phòng này? Thao tác này sẽ đưa đặt phòng vào thùng rác.")) {
            try {
                const response = await fetch(`${API_URL}/bookings/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                if (!response.ok) throw new Error('Lỗi khi xóa đặt phòng.');
                alert('Đã đưa đặt phòng vào thùng rác!');
                fetchAndRenderBookings(); // Tải lại danh sách
            } catch (error) {
                alert(error.message);
            }
        }
    }

    // Hủy đặt phòng
    async function cancelBooking(id) {
        // Gọi updateBookingStatus với trạng thái 'cancelled'
        await updateBookingStatus(id, 'cancelled');
    }

    // Cập nhật trạng thái
    async function updateBookingStatus(id, status, isInternalCall = false) {
        // isInternalCall: cờ để biết hàm được gọi từ saveBooking hay từ nút bên ngoài
        if (!isInternalCall && !confirm(`Bạn có chắc muốn đổi trạng thái thành "${status}"?`)) return;

        try {
            const response = await fetch(`${API_URL}/bookings/${id}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` },
                body: JSON.stringify({ status: status })
            });
            if (!response.ok) throw new Error('Lỗi khi cập nhật trạng thái.');

            if (!isInternalCall) { // Chỉ thông báo nếu gọi từ bên ngoài
                alert('Cập nhật trạng thái thành công!');
                fetchAndRenderBookings();
            }
        } catch (error) {
            alert(error.message);
            throw error; // Ném lỗi để hàm saveBooking có thể bắt được
        }
    }

    // Xem chi tiết
    async function showBookingDetail(id) {
        try {
            const response = await fetch(`${API_URL}/bookings/${id}`, { headers: { 'Authorization': `Bearer ${TOKEN}` } });
            if (!response.ok) throw new Error('Không tìm thấy thông tin đặt phòng.');
            const b = await response.json();
            const statusText = {
                'pending': "Đang chờ", 'confirmed': "Đã xác nhận", 'checked-in': "Đã check-in",
                'checked-out': "Đã check-out", 'cancelled': "Đã hủy"
            }[b.status] || b.status;

            // === SỬA ĐỔI HIỂN THỊ CHI TIẾT ===
            document.getElementById('detailBookingBody').innerHTML = `
                <p><strong>Mã đặt phòng:</strong> ${b.code}</p>
                <p><strong>Khách hàng:</strong> ${b.customer} (${b.phone})</p>
                <p><strong>Số khách:</strong> ${b.soNguoiLon} người lớn, ${b.soTreEm} trẻ em</p>
                <p><strong>Phòng:</strong> ${b.roomType} ${b.roomNumber}</p>
                <p><strong>Nhận phòng:</strong> ${formatDate(b.checkin)}</p>
                <p><strong>Trả phòng:</strong> ${formatDate(b.checkout)}</p>
                <p><strong>Số đêm:</strong> ${b.nights}</p>
                <p><strong>Tổng tiền:</strong> ${(b.total || 0).toLocaleString()} VND</p>
                <p><strong>Trạng thái:</strong> ${statusText}</p>
            `;
            // === KẾT THÚC SỬA ĐỔI ===

            new bootstrap.Modal(document.getElementById('detailBookingModal')).show();
        } catch (error) {
            alert(error.message);
        }
    }

    // Tải loại phòng cho bộ lọc
    async function loadRoomTypes() {
        try {
            const response = await fetch(`${API_URL}/room-types`, { headers: { 'Authorization': `Bearer ${TOKEN}` } });
            if (!response.ok) throw new Error('Lỗi tải loại phòng.');
            const roomTypes = await response.json();
            const select = document.getElementById('filterRoomType');
            roomTypes.forEach(rt => {
                select.innerHTML += `<option value="${rt.id}">${rt.name}</option>`;
            });
        } catch (error) {
            console.error(error.message);
        }
    }

    // Tải danh sách phòng vào modal
    async function loadRoomsIntoModal(selectedRoomId = null) {
        try {
            const response = await fetch(`${API_URL}/rooms`, { headers: { 'Authorization': `Bearer ${TOKEN}` } });

            if (!response.ok) {
                console.error("Failed to load rooms. Status: " + response.status);
                throw new Error('Lỗi tải danh sách phòng.');
            }
            const rooms = await response.json();
            const select = document.getElementById('inputRoomId');
            select.innerHTML = '<option value="">Chọn phòng</option>';
            rooms.forEach(r => {
                const isSelected = r.id == selectedRoomId;

                if(r.status=="AVAILABLE" || isSelected) { // Cho phép hiển thị phòng Sẵn có HOẶC phòng đang được chọn (để sửa)

                    select.innerHTML += `<option
                                        value="${r.id}"
                                        data-price="${r.pricePerNight || 0}"
                                        ${isSelected ? 'selected' : ''}>
                                        ${r.roomNumber} - ${r.roomTypeName}
                                    </option>`;
                }
            });
        } catch (error)
        {
            console.error(error.message);
        }
    }

    // Hàm tự động tính tổng tiền
    function calculateTotalPrice() {
        const roomSelect = document.getElementById('inputRoomId');
        const checkinDateEl = document.getElementById('inputCheckin');
        const checkoutDateEl = document.getElementById('inputCheckout');
        const totalEl = document.getElementById('inputTotal');

        try {
            const selectedOption = roomSelect.options[roomSelect.selectedIndex];
            const pricePerNight = parseFloat(selectedOption.dataset.price || 0);
            const checkin = new Date(checkinDateEl.value);
            const checkout = new Date(checkoutDateEl.value);

            if (!isNaN(checkin.getTime()) && !isNaN(checkout.getTime()) && pricePerNight > 0) {
                const timeDiff = checkout.getTime() - checkin.getTime();
                const nights = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

                if (nights > 0) {
                    totalEl.value = nights * pricePerNight;
                } else {
                    totalEl.value = 0;
                }
            } else {
                totalEl.value = 0;
            }
        } catch (error) {
            console.error("Lỗi khi tính giá:", error);
            totalEl.value = 0;
        }
    }

    // Các hàm tiện ích
    function getInitials(name) {
        if (!name) return '';
        return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
    }
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const [year, month, day] = dateStr.split('-');
        return `${day}/${month}/${year}`;
    }

    // === ⭐ 4. KHỐI GÁN SỰ KIỆN ĐÃ CẬP NHẬT ===
    document.getElementById('btnApplyFilter').onclick = applyFilters;
    document.getElementById('filterSearch').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            applyFilters();
        }
    });

    const btnShowTrash = document.getElementById('btnShowTrash');

    // 1. Khi nhấn vào một bộ lọc trạng thái (Tất cả, Đang chờ,...)
    document.querySelectorAll('#statusFilterGroup input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', () => {
            // Đặt trạng thái theo radio
            currentFilters.status = radio.value;
            currentFilters.page = 0; // Reset trang

            // Gọi hàm fetch chính
            fetchAndRenderBookings();

            // Tắt "active" của nút Thùng Rác (nếu nó đang active)
            btnShowTrash.classList.remove('active');
        });
    });

    // 2. Khi nhấn vào nút "Thùng Rác"
    btnShowTrash.addEventListener('click', () => {
        // Đặt trạng thái (status) là 'trash'
        currentFilters.status = 'trash';
        currentFilters.page = 0; // Reset trang

        // Gọi hàm fetch chính (hàm này đã biết cách xử lý 'trash')
        fetchAndRenderBookings();

        // Tắt "checked" của nhóm radio (bỏ check tất cả)
        document.querySelectorAll('#statusFilterGroup input[type="radio"]').forEach(r => r.checked = false);
        // Set "Tất cả" (id btnradio1) làm checked về mặt logic, nhưng ko kích hoạt sự kiện
        document.getElementById('btnradio1').checked = true;


        // Tự bật "active" cho nút Thùng Rác
        btnShowTrash.classList.add('active');
    });


    document.getElementById('btnSaveBooking').onclick = saveBooking;
    // === KẾT THÚC THAY THẾ KHỐI SỰ KIỆN ===

    document.getElementById('inputRoomId').addEventListener('change', calculateTotalPrice);
    document.getElementById('inputCheckin').addEventListener('change', calculateTotalPrice);
    document.getElementById('inputCheckout').addEventListener('change', calculateTotalPrice);


    // CẬP NHẬT: Khởi tạo khi tải trang
    document.addEventListener('DOMContentLoaded', () => {
        if (!TOKEN) {
            alert('Bạn chưa đăng nhập. Đang chuyển đến trang đăng nhập.');
            window.location.href = 'pages-login.html';
            return;
        }

        // THÊM MỚI: Gắn sự kiện cho các nút chuyển đổi chế độ xem
        document.getElementById('gridView').addEventListener('click', () => toggleView('grid'));
        document.getElementById('listView').addEventListener('click', () => toggleView('list'));

        // Tải dữ liệu ban đầu
        loadRoomTypes();
        fetchAndRenderBookings();

        // THÊM MỚI: Kích hoạt chế độ xem mặc định (grid)
        toggleView('grid');
    });
</script>
</body>
</html>
