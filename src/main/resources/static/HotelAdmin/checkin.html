<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Check-in - HotelAdmin</title>
    <link href="assets/img/img.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
    <style>
        .checkin-card {
            border-left: 4px solid #0dcaf0; /* Info color for check-in */
            transition: all 0.3s ease;
        }
        .checkin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        /* CSS for stats (removed) is gone */
        .overdue-booking { /* Changed from urgent-booking */
            border-left: 4px solid #dc3545 !important; /* Danger color for overdue */
            animation: pulse 1.5s infinite alternate;
        }
        @keyframes pulse {
            from { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            to { box-shadow: 0 0 0 5px rgba(220, 53, 69, 0); }
        }
        .customer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.875rem;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.35em 0.65em;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        .alert-custom {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }
        /* Style for checked-in cards (optional) */
        .checked-in-card {
            border-left-color: #198754 !important; /* Success color */
            opacity: 0.8;
        }
    </style>
</head>
<body>

<header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
        <a href="index.html" class="logo d-flex align-items-center">
            <img src="assets/img/logo.png" alt="Logo">
            <span class="d-none d-lg-block">Hotel</span>
        </a>
        <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><div class="search-bar">
    <form class="search-form d-flex align-items-center" method="POST" action="#">
        <input type="text" name="query" placeholder="T√¨m ki·∫øm ƒë·∫∑t ph√≤ng, kh√°ch h√†ng..." title="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm">
        <button type="submit" title="T√¨m ki·∫øm"><i class="bi bi-search"></i></button>
    </form>
</div><nav class="header-nav ms-auto">
    <ul class="d-flex align-items-center">

        <li class="nav-item d-block d-lg-none">
            <a class="nav-link nav-icon search-bar-toggle " href="#">
                <i class="bi bi-search"></i>
            </a>
        </li><li class="nav-item dropdown">
        <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-bell"></i>
            <span class="badge bg-primary badge-number">3</span>
        </a><ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications">
        <li class="dropdown-header">
            B·∫°n c√≥ 3 th√¥ng b√°o m·ªõi
            <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">Xem t·∫•t c·∫£</span></a>
        </li>
        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-exclamation-circle text-warning"></i>
            <div>
                <h4>ƒê·∫∑t ph√≤ng m·ªõi</h4>
                <p>Kh√°ch h√†ng Nguy·ªÖn VƒÉn A v·ª´a ƒë·∫∑t ph√≤ng Deluxe</p>
                <p>5 ph√∫t tr∆∞·ªõc</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-x-circle text-danger"></i>
            <div>
                <h4>H·ªßy ƒë·∫∑t ph√≤ng</h4>
                <p>ƒê·∫∑t ph√≤ng #2457 ƒë√£ b·ªã h·ªßy</p>
                <p>2 gi·ªù tr∆∞·ªõc</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-check-circle text-success"></i>
            <div>
                <h4>Ph·∫£n h·ªìi m·ªõi</h4>
                <p>B·∫°n c√≥ 2 ƒë√°nh gi√° m·ªõi t·ª´ kh√°ch h√†ng</p>
                <p>4 gi·ªù tr∆∞·ªõc</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>
        <li class="dropdown-footer">
            <a href="#">Hi·ªÉn th·ªã t·∫•t c·∫£ th√¥ng b√°o</a>
        </li>
    </ul></li><li class="nav-item dropdown pe-3">

        <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <img src="assets/img/profile-img.jpg" alt="H·ªì s∆°" class="rounded-circle">
            <span class="d-none d-md-block dropdown-toggle ps-2" id="profileName">ƒêang t·∫£i...</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li class="dropdown-header">
                <h6 id="profileDropdownName">...</h6>
                <span id="profileDropdownRole">...</span>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                    <i class="bi bi-person"></i>
                    <span>H·ªì s∆° c·ªßa t√¥i</span>
                </a>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                    <i class="bi bi-gear"></i>
                    <span>C√†i ƒë·∫∑t t√†i kho·∫£n</span>
                </a>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="#" id="logoutButton">
                    <i class="bi bi-box-arrow-right"></i>
                    <span>ƒêƒÉng xu·∫•t</span>
                </a>
            </li>
        </ul></li></ul>
</nav>
</header><aside id="sidebar" class="sidebar">
    <ul class="sidebar-nav" id="sidebar-nav">
        <li class="nav-item"><a class="nav-link collapsed" href="index.html"><i class="bi bi-house-door"></i><span>B·∫£ng ƒêi·ªÅu Khi·ªÉn</span></a></li>
        <li class="nav-item">
            <a class="nav-link " data-bs-target="#booking-nav" data-bs-toggle="collapse" href="#"><i class="bi bi-calendar-check"></i><span>Qu·∫£n l√Ω ƒê·∫∑t ph√≤ng</span><i class="bi bi-chevron-down ms-auto"></i></a>
            <ul id="booking-nav" class="nav-content collapse show" data-bs-parent="#sidebar-nav">
                <li><a href="tatcadatphong.html"><i class="bi bi-circle"></i><span>T·∫•t c·∫£ ƒë·∫∑t ph√≤ng</span></a></li>
                <li><a href="checkin.html" class="active"><i class="bi bi-circle"></i><span>Check-in</span></a></li>
                <li><a href="checkout.html"><i class="bi bi-circle"></i><span>Check-out</span></a></li>
            </ul>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#room-nav" data-bs-toggle="collapse" href="#"><i class="bi bi-door-closed"></i><span>Qu·∫£n l√Ω Ph√≤ng</span><i class="bi bi-chevron-down ms-auto"></i></a>
            <ul id="room-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
                <li><a href="danhsachphong.html"><i class="bi bi-circle"></i><span>Danh s√°ch ph√≤ng</span></a></li>
                <li><a href="loaiphong.html"><i class="bi bi-circle"></i><span>Lo·∫°i ph√≤ng</span></a></li>
                <li><a href="tinhtrangphong.html"><i class="bi bi-circle"></i><span>T√¨nh tr·∫°ng ph√≤ng</span></a></li>
                <li><a href="giaphong.html"><i class="bi bi-circle"></i><span>Gi√° ph√≤ng</span></a></li>
            </ul>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#customer-nav" data-bs-toggle="collapse" href="#"><i class="bi bi-people"></i><span>Qu·∫£n l√Ω Kh√°ch h√†ng</span><i class="bi bi-chevron-down ms-auto"></i></a>
            <ul id="customer-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
                <li><a href="danhsachkhachhang.html"><i class="bi bi-circle"></i><span>Danh s√°ch kh√°ch h√†ng</span></a></li>
                <li><a href="chuongtrinhthanhvien.html"><i class="bi bi-circle"></i><span>Ch∆∞∆°ng tr√¨nh th√†nh vi√™n</span></a></li>
                <li><a href="danhgia&phanhoi.html"><i class="bi bi-circle"></i><span>ƒê√°nh gi√° & Ph·∫£n h·ªìi</span></a></li>
            </ul>
        </li>
        <li class="nav-item"><a class="nav-link collapsed" href="baocao&thongke.html"><i class="bi bi-bar-chart"></i><span>B√°o c√°o & Th·ªëng k√™</span></a></li>
        <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#finance-nav" data-bs-toggle="collapse" href="#"><i class="bi bi-cash-coin"></i><span>T√†i ch√≠nh</span><i class="bi bi-chevron-down ms-auto"></i></a>
            <ul id="finance-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
                <li><a href="finance-invoices.html"><i class="bi bi-circle"></i><span>H√≥a ƒë∆°n</span></a></li>
                <li><a href="finance-payments.html"><i class="bi bi-circle"></i><span>Thanh to√°n</span></a></li>
                <li><a href="finance-revenue.html"><i class="bi bi-circle"></i><span>Doanh thu</span></a></li>
            </ul>
        </li>
        <li class="nav-heading">Trang</li>
        <li class="nav-item"><a class="nav-link collapsed" href="users-profile.html"><i class="bi bi-person"></i><span>H·ªì s∆°</span></a></li>
        <li class="nav-item"><a class="nav-link collapsed" href="pages-contact.html"><i class="bi bi-envelope"></i><span>Li√™n h·ªá</span></a></li>
        <li class="nav-item"><a class="nav-link collapsed" href="users.html"><i class="bi bi-person-gear"></i><span>Nh√¢n vi√™n</span></a></li>
        <li class="nav-item"><a class="nav-link collapsed" href="taikhoan.html"><i class="bi bi-person-badge"></i><span>T√†i kho·∫£n</span></a></li>
        <li class="nav-item"><a class="nav-link collapsed" href="settings.html"><i class="bi bi-gear"></i><span>C√†i ƒë·∫∑t</span></a></li>
    </ul>
</aside><main id="main" class="main">
    <div class="pagetitle d-flex justify-content-between align-items-center">
        <h1>Check-in</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Trang ch·ªß</a></li>
                <li class="breadcrumb-item">Qu·∫£n l√Ω ƒê·∫∑t ph√≤ng</li>
                <li class="breadcrumb-item active">Check-in</li>
            </ol>
        </nav>
    </div>
    <section class="section">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title">Danh s√°ch ch·ªù check-in</h5>
                            <div><button class="btn btn-outline-primary" onclick="loadCheckins(true)"><i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi</button></div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-3"><label class="form-label">T·ª´ ng√†y</label><input type="date" class="form-control" id="filterCheckinDateFrom"></div>
                            <div class="col-md-3"><label class="form-label">ƒê·∫øn ng√†y</label><input type="date" class="form-control" id="filterCheckinDateTo"></div>
                            <div class="col-md-3">
                                <label class="form-label">Tr·∫°ng th√°i Check-in</label>
                                <select class="form-select" id="filterCheckinStatus">
                                    <option value="all" selected>T·∫•t c·∫£ ch·ªù & qu√° h·∫°n</option>
                                    <option value="pending">Ch·ªù check-in</option>
                                    <option value="overdue">Qu√° h·∫°n</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end"><button class="btn btn-primary w-100" id="filterBtn">L·ªçc</button></div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label">Lo·∫°i ph√≤ng</label>
                                <select class="form-select" id="filterRoomType">
                                    <option value="" selected>T·∫•t c·∫£ lo·∫°i ph√≤ng</option>
                                </select>
                            </div>
                            <div class="col-md-5"><label class="form-label">T√¨m ki·∫øm</label><input type="text" class="form-control" placeholder="M√£ ƒë·∫∑t ph√≤ng, t√™n, SƒêT..." id="searchInput"></div>
                            <div class="col-md-3 d-flex align-items-end">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="showOverdueOnly">
                                    <label class="form-check-label" for="showOverdueOnly">Ch·ªâ hi·ªÉn th·ªã qu√° h·∫°n</label>
                                </div>
                            </div>
                        </div>

                        <div class="loading-spinner" id="loadingSpinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">ƒêang t·∫£i...</span></div><p class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p></div>

                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="checkinContainer">
                        </div>

                        <div class="empty-state d-none" id="emptyState"><i class="bi bi-calendar-x"></i><h4>Kh√¥ng c√≥ ƒë·∫∑t ph√≤ng ch·ªù check-in</h4><p>Kh√¥ng t√¨m th·∫•y ƒë·∫∑t ph√≤ng n√†o c√≥ tr·∫°ng th√°i "ƒê√£ x√°c nh·∫≠n" ph√π h·ª£p.</p><button class="btn btn-primary" onclick="resetFilters()"><i class="bi bi-arrow-clockwise"></i> ƒê·∫∑t l·∫°i b·ªô l·ªçc</button></div>

                        <nav aria-label="Page navigation" id="paginationContainer"><ul class="pagination justify-content-center" id="pagination"></ul></nav>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<div class="modal fade" id="bookingDetailModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Chi ti·∫øt ƒë·∫∑t ph√≤ng</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="bookingDetailContent"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button><button type="button" class="btn btn-primary" onclick="processCheckinFromDetail()">Ti·∫øn h√†nh Check-in</button></div></div></div></div>

<div class="modal fade" id="checkinModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">X√°c nh·∫≠n Check-in</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row"><div class="col-md-6"><h6>Th√¥ng tin kh√°ch h√†ng</h6><div class="mb-3" id="checkinCustomerInfo"></div></div><div class="col-md-6"><h6>Thanh to√°n</h6><div class="mb-3" id="checkinPaymentInfo"></div></div></div><hr><div class="mb-3"><label class="form-label">Ghi ch√∫ check-in</label><textarea class="form-control" rows="3" id="checkinNotes" placeholder="Ghi ch√∫ v·ªÅ t√¨nh tr·∫°ng ph√≤ng, y√™u c·∫ßu ƒë·∫∑c bi·ªát..."></textarea></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="confirmCheckin"><label class="form-check-label" for="confirmCheckin">X√°c nh·∫≠n kh√°ch h√†ng ƒë√£ nh·∫≠n ph√≤ng v√† thanh to√°n ƒë·∫ßy ƒë·ªß (n·∫øu c·∫ßn)</label></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button><button type="button" class="btn btn-success" id="checkinConfirmBtn">X√°c nh·∫≠n Check-in</button></div></div></div></div>

<footer id="footer" class="footer"><div class="copyright">&copy; B·∫£n quy·ªÅn <strong><span>HotelAdmin</span></strong>. T·∫•t c·∫£ c√°c quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u</div><div class="credits">Thi·∫øt k·∫ø b·ªüi <a href="#">Nh√≥m Ph√°t tri·ªÉn</a></div></footer>

<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/main.js"></script>
<script src="assets/js/auth.js"></script>
<script>
    // === C·∫§U H√åNH V√Ä BI·∫æN TO√ÄN C·ª§C ===
    const API_BASE_URL = '/api/admin'; // ƒê·ªãa ch·ªâ g·ªëc API
    let allCheckinBookings = []; // D·ªØ li·ªáu g·ªëc t·ª´ API
    let filteredCheckins = []; // D·ªØ li·ªáu ƒë√£ l·ªçc ƒë·ªÉ hi·ªÉn th·ªã
    let currentProcessingBooking = null; // Booking ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω (view detail/checkin)
    let roomTypes = []; // L∆∞u danh s√°ch lo·∫°i ph√≤ng

    // Bi·∫øn ph√¢n trang
    let currentPage = 0;
    const itemsPerPage = 6;
    let totalPages = 0;

    // === KH·ªûI T·∫†O TRANG ===
    document.addEventListener('DOMContentLoaded', async () => {
        if (!localStorage.getItem('jwtToken')) {
            alert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.');
            window.location.href = '/HotelAdmin/pages-login.html';
            return;
        }
        initializePageDefaults();
        await loadRoomTypes(); // T·∫£i lo·∫°i ph√≤ng tr∆∞·ªõc
        setupEventListeners();
        await loadCheckins(true); // T·∫£i d·ªØ li·ªáu l·∫ßn ƒë·∫ßu
    });

    function initializePageDefaults() {
        // Set default date range (e.g., today)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filterCheckinDateFrom').value = today;
        document.getElementById('filterCheckinDateTo').value = today;
    }

    async function loadRoomTypes() {
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/room-types`);
            if (!response.ok) throw new Error('L·ªói t·∫£i lo·∫°i ph√≤ng');
            roomTypes = await response.json();

            const select = document.getElementById('filterRoomType');
            select.innerHTML = '<option value="" selected>T·∫•t c·∫£ lo·∫°i ph√≤ng</option>'; // Reset
            roomTypes.forEach(rt => {
                select.innerHTML += `<option value="${rt.id}">${rt.name}</option>`;
            });
        } catch (error) {
            console.error("L·ªói t·∫£i lo·∫°i ph√≤ng:", error);
            showAlert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch lo·∫°i ph√≤ng.', 'danger');
        }
    }

    function setupEventListeners() {
        // Debounced search
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFiltersAndFetch();
            }, 300);
        });

        // Filter button
        document.getElementById('filterBtn').onclick = applyFiltersAndFetch;

        // Other filters trigger refetch
        document.getElementById('filterCheckinStatus').addEventListener('change', applyFiltersAndFetch);
        document.getElementById('filterRoomType').addEventListener('change', applyFiltersAndFetch);
        document.getElementById('filterCheckinDateFrom').addEventListener('change', applyFiltersAndFetch);
        document.getElementById('filterCheckinDateTo').addEventListener('change', applyFiltersAndFetch);
        document.getElementById('showOverdueOnly').addEventListener('change', applyFiltersAndFetch);

        // Event delegation for action buttons
        document.getElementById('checkinContainer').addEventListener('click', handleCheckinActions);

        // Check-in confirmation button
        document.getElementById('checkinConfirmBtn').onclick = confirmCheckinAction;
    }

    // === T·∫¢I V√Ä HI·ªÇN TH·ªä D·ªÆ LI·ªÜU ===

    // === T·∫¢I V√Ä HI·ªÇN TH·ªä D·ªÆ LI·ªÜU (ƒê√É S·ª¨A L·ªñI G·ª¨I PARAMETER) ===
    async function loadCheckins(resetPage = false) {
        showLoading();
        if (resetPage) currentPage = 0;

        const params = new URLSearchParams();
        params.append('page', currentPage);
        params.append('size', itemsPerPage);
        params.append('sort', 'checkInDate,asc'); // S·∫Øp x·∫øp theo ng√†y check-in tƒÉng d·∫ßn
        params.append('status', 'CONFIRMED'); // CH·ªà L·∫§Y ƒê∆†N ƒê√É X√ÅC NH·∫¨N

        // --- L·∫•y gi√° tr·ªã b·ªô l·ªçc t·ª´ UI ---
        const fromDate = document.getElementById('filterCheckinDateFrom').value;
        const toDate = document.getElementById('filterCheckinDateTo').value;
        const roomTypeId = document.getElementById('filterRoomType').value;
        const searchTerm = document.getElementById('searchInput').value.trim(); // L·∫•y gi√° tr·ªã t√¨m ki·∫øm
        const checkinStatusFilter = document.getElementById('filterCheckinStatus').value;
        const showOverdueOnly = document.getElementById('showOverdueOnly').checked;

        // --- Th√™m b·ªô l·ªçc v√†o params N·∫æU C√ì GI√Å TR·ªä ---
        if (fromDate) params.append('checkinFrom', fromDate);
        if (toDate) params.append('checkinTo', toDate);
        if (roomTypeId) params.append('roomTypeId', roomTypeId);

        // === S·ª¨A L·ªñI T·∫†I ƒê√ÇY ===
        // Ch·ªâ th√™m tham s·ªë 'search' n·∫øu searchTerm kh√¥ng r·ªóng
        if (searchTerm) {
            params.append('search', searchTerm); // G·ª≠i ƒë√∫ng t√™n tham s·ªë l√† 'search'
        }
        // ========================

        // B·ªô l·ªçc 'checkinStatus' v√† 'showOverdueOnly' s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω ph√≠a client sau khi fetch

        try {
            // S·ª≠ d·ª•ng endpoint /search
            const response = await fetchWithAuth(`${API_BASE_URL}/bookings?${params.toString()}`);

            if (!response.ok) {
                // X·ª≠ l√Ω l·ªói (gi·ªØ nguy√™n nh∆∞ code c≈© c·ªßa b·∫°n)
                let errorMsg = 'L·ªói t·∫£i danh s√°ch check-in.';
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.message || errorMsg;
                } catch(e) {}
                throw new Error(errorMsg);
            }

            const pageData = await response.json();
            allCheckinBookings = pageData.content || [];
            totalPages = pageData.totalPages || 0;

            // Apply client-side filters for checkin status (pending/overdue)
            applyClientSideFilters(checkinStatusFilter, showOverdueOnly);

            renderCheckins(); // Render the filtered data
            renderPagination(pageData);
            // H√ÄM updateStatistics() ƒê√É B·ªä X√ìA

        } catch (error) {
            console.error('L·ªói khi t·∫£i check-ins:', error);
            showAlert(error.message || 'C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu.', 'danger');
            document.getElementById('checkinContainer').innerHTML = ''; // Clear content on error
            document.getElementById('pagination').innerHTML = '';
            showEmptyStateIfNeeded();
        } finally {
            hideLoading();
        }
    }

    // H√†m m·ªõi ƒë·ªÉ √°p d·ª•ng b·ªô l·ªçc client-side (pending/overdue)
    function applyClientSideFilters(checkinStatusFilter, showOverdueOnly) {
        const todayStr = new Date().toISOString().split('T')[0];
        filteredCheckins = allCheckinBookings.filter(booking => {
            const isOverdue = booking.check_in_date < todayStr;
            const currentCheckinStatus = isOverdue ? 'overdue' : 'pending';

            if (showOverdueOnly && !isOverdue) {
                return false;
            }
            if (checkinStatusFilter !== 'all' && currentCheckinStatus !== checkinStatusFilter) {
                return false;
            }
            return true;
        });
    }


    // Trigger refetch when filters change
    function applyFiltersAndFetch() {
        loadCheckins(true); // Reset to page 0 and refetch
    }

    function renderCheckins() {
        const container = document.getElementById('checkinContainer');
        container.innerHTML = ''; // Clear previous items

        if (filteredCheckins.length === 0) {
            showEmptyStateIfNeeded();
            return;
        }

        hideEmptyState();
        const fragment = document.createDocumentFragment();
        filteredCheckins.forEach(booking => {
            const checkinElement = createCheckinElement(booking);
            fragment.appendChild(checkinElement);
        });
        container.appendChild(fragment);
    }

    function createCheckinElement(booking) {
        const colDiv = document.createElement('div');
        // ===== üåü ƒê√É S·ª¨A L·ªñI LAYOUT B∆Ø·ªöC 2 üåü =====
        colDiv.className = 'col'; // S·ª≠a t·ª´ 'col-xl-6 mb-4' th√†nh 'col'

        const todayStr = new Date().toISOString().split('T')[0];
        // === S·ª¨A T√äN C·ªòT ===
        const isOverdue = booking.checkin < todayStr; // Use booking.checkin
        const checkinStatus = isOverdue ? 'overdue' : 'pending';

        // G√°n n·ªôi dung th·∫ª (gi·ªØ nguy√™n)
        colDiv.innerHTML = `
        <div class="card checkin-card ${isOverdue ? 'overdue-booking' : ''}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>

                        <h6 class="card-title mb-1">${booking.code || 'N/A'}</h6>
                        <small class="text-muted">Ng√†y check-in: ${formatDate(booking.checkin)}</small>
                    </div>
                    <div>
                        <span class="badge ${getCheckinStatusBadgeClass(checkinStatus)} status-badge">
                            ${getCheckinStatusText(checkinStatus)}
                        </span>
                    </div>
                </div>

                <div class="customer-info mb-3">
                    <div class="d-flex align-items-center mb-2">

                         <div class="customer-avatar ${getAvatarColor(getInitials(booking.customer || ''))} me-2">
                            ${getInitials(booking.customer || '?')}
                        </div>
                        <div>
                            <div class="fw-bold">${booking.customer || 'N/A'}</div>
                        </div>
                    </div>
                </div>

                <div class="booking-info">
                    <div >
                        <div class="row">

                            <div class="fw-bold">${booking.roomType || 'N/A'} ${booking.roomNumber || 'N/A'}</div>
                        </div><br>
                        <div class="row">
                            <small class="text-muted">Th·ªùi gian</small>

                            <div>${formatDate(booking.checkin)} - ${formatDate(booking.checkout)}</div>

                        </div>
                    </div>

                </div>

                <div class="checkin-actions mt-3">
                    <div class="btn-group w-100">

                        <button class="btn btn-sm btn-outline-primary" data-booking-id="${booking.id}">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-success" data-booking-id="${booking.id}">
                            <i class="bi bi-check-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" data-phone="${booking.phone || ''}">
                            <i class="bi bi-telephone"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
        return colDiv;
    }

    // === X·ª¨ L√ù H√ÄNH ƒê·ªòNG ===

    function handleCheckinActions(e) {
        const button = e.target.closest('button');
        if (!button) return;

        const bookingId = button.dataset.bookingId;
        const phone = button.dataset.phone;

        if (button.classList.contains('btn-outline-primary') && bookingId) {
            viewBookingDetail(bookingId);
        } else if (button.classList.contains('btn-success') && bookingId) {
            openCheckinModal(bookingId);
        } else if (button.classList.contains('btn-outline-warning') && phone) {
            callCustomer(phone);
        }
    }

    async function viewBookingDetail(bookingId) {
        showLoading();
        try {
            // Find in the current list first
            let booking = filteredCheckins.find(b => b.id == bookingId); // Use filtered list

            // If not found (e.g., loaded via different filter), fetch directly
            if (!booking) {
                console.log(`Booking ${bookingId} not in current filter, fetching details...`)
                const response = await fetchWithAuth(`${API_BASE_URL}/bookings/${bookingId}`);
                if (!response.ok) throw new Error('Kh√¥ng t√¨m th·∫•y chi ti·∫øt ƒë·∫∑t ph√≤ng.');
                booking = await response.json(); // Use the fetched details
            }

            currentProcessingBooking = booking; // Store the correct booking object

            const modalContent = document.getElementById('bookingDetailContent');
            // === S·ª¨A T√äN C·ªòT ===
            modalContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Th√¥ng tin kh√°ch h√†ng</h6>
                    <div class="mb-3">
                        <strong>H·ªç t√™n:</strong> ${booking.customer || 'N/A'}<br>
                        <strong>SƒêT:</strong> ${booking.phone || 'N/A'}<br>

                    </div>
                </div>
                <div class="col-md-6">
                    <h6>Th√¥ng tin ƒë·∫∑t ph√≤ng</h6>
                    <div class="mb-3">
                        <strong>M√£ ƒë·∫∑t ph√≤ng:</strong> ${booking.code || 'N/A'}<br>
                        <strong>Ph√≤ng:</strong> ${booking.roomType || 'N/A'} ${booking.roomNumber || 'N/A'}<br>
                        <strong>Th·ªùi gian:</strong> ${formatDate(booking.checkin)} - ${formatDate(booking.checkout)}<br>
                        <strong>S·ªë ƒë√™m:</strong> ${calculateNights(booking.checkin, booking.checkout)} ƒë√™m<br>
                        <strong>S·ªë kh√°ch:</strong> ${(booking.soNguoiLon)} ng∆∞·ªùi l·ªõn,${(booking.soTreEm)} tr·∫ª em<br>
                        <strong>T·ªïng ti·ªÅn:</strong> ${formatCurrency(booking.total || 0)}<br>
                        <strong>Tr·∫°ng th√°i:</strong> <span class="badge bg-success">${getStatusText(booking.status)}</span>
                    </div>
                </div>
            </div>

            ${booking.notes ? `<div class="row"><div class="col-12"><h6>Ghi ch√∫</h6><p>${booking.notes}</p></div></div>` : ''}
        `;

            new bootstrap.Modal(document.getElementById('bookingDetailModal')).show();
        } catch(error){
            showAlert(error.message || 'L·ªói khi xem chi ti·∫øt.', 'danger');
        } finally {
            hideLoading();
        }
    }
    // Function to trigger check-in modal from detail modal
    function processCheckinFromDetail() {
        const detailModal = bootstrap.Modal.getInstance(document.getElementById('bookingDetailModal'));
        if (detailModal) detailModal.hide();

        // Ensure currentProcessingBooking is set
        if (currentProcessingBooking) {
            // Use setTimeout to allow the first modal to fully hide
            setTimeout(() => {
                openCheckinModal(currentProcessingBooking.id);
            }, 300); // Adjust timeout if needed
        } else {
            showAlert('Kh√¥ng c√≥ th√¥ng tin ƒë·∫∑t ph√≤ng ƒë·ªÉ check-in.', 'warning');
        }
    }


    function openCheckinModal(bookingId) {
        // Find booking data using the CORRECT list (filteredCheckins)
        const booking = filteredCheckins.find(b => b.id == bookingId); // Use filtered list
        if (!booking) {
            showAlert('Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·∫∑t ph√≤ng trong danh s√°ch hi·ªán t·∫°i!', 'danger');
            return;
        }
        currentProcessingBooking = booking; // Store for confirmation

        // === S·ª¨A T√äN C·ªòT ===
        document.getElementById('checkinCustomerInfo').innerHTML = `
        <strong>H·ªç t√™n:</strong> ${booking.customer || 'N/A'}<br>
        <strong>SƒêT:</strong> ${booking.phone || 'N/A'}<br>
        <strong>Ph√≤ng:</strong> ${booking.roomType || 'N/A'} ${booking.roomNumber || 'N/A'}<br>
        <strong>Th·ªùi gian:</strong> ${formatDate(booking.checkin)} - ${formatDate(booking.checkout)}
    `;
        document.getElementById('checkinPaymentInfo').innerHTML = `
        <strong class="text-primary">T·ªïng ti·ªÅn: ${formatCurrency(booking.total || 0)}</strong><br>
        <small>(Ki·ªÉm tra thanh to√°n n·∫øu c·∫ßn)</small>
    `;

        document.getElementById('confirmCheckin').checked = false;
        document.getElementById('checkinNotes').value = '';

        new bootstrap.Modal(document.getElementById('checkinModal')).show();
    }
    async function confirmCheckinAction() {
        if (!document.getElementById('confirmCheckin').checked) {
            showAlert('Vui l√≤ng x√°c nh·∫≠n c√°c th√¥ng tin tr∆∞·ªõc khi check-in!', 'warning');
            return;
        }
        if (!currentProcessingBooking) {
            showAlert('L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·∫∑t ph√≤ng ƒëang x·ª≠ l√Ω!', 'danger');
            return;
        }

        const bookingId = currentProcessingBooking.id;
        const checkinNotes = document.getElementById('checkinNotes').value; // Get notes if needed

        showLoading(); // Show loading indicator
        const checkinModalInstance = bootstrap.Modal.getInstance(document.getElementById('checkinModal'));


        try {
            // Call API to update status
            const response = await fetchWithAuth(`${API_BASE_URL}/bookings/${bookingId}/status`, {
                method: 'PATCH',
                body: JSON.stringify({ status: 'CHECKED_IN' }) // Update status to CHECKED_IN
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i check-in.');
            }

            // Successfully checked in
            if(checkinModalInstance) checkinModalInstance.hide(); // Hide modal on success

            showAlert('Check-in th√†nh c√¥ng!', 'success');
            await loadCheckins(true); // Refresh list

        } catch (error) {
            console.error('L·ªói khi x√°c nh·∫≠n check-in:', error);
            showAlert(error.message || 'C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh check-in.', 'danger');
        } finally {
            hideLoading(); // Hide loading indicator
        }
    }


    function callCustomer(phone) {
        if (phone) {
            showAlert(`ƒêang g·ªçi ƒë·∫øn s·ªë: ${phone}... (Gi·∫£ l·∫≠p)`, 'info');
            // In a real app, you might trigger a call using a browser extension or API
            // window.location.href = `tel:${phone}`; // This might work on mobile
        } else {
            showAlert('Kh√¥ng c√≥ s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ g·ªçi.', 'warning');
        }
    }

    // === PH√ÇN TRANG ===

    function renderPagination(pageData) {
        const paginationUl = document.getElementById('pagination');
        paginationUl.innerHTML = ''; // Clear old pagination
        totalPages = pageData.totalPages || 0;
        currentPage = pageData.number || 0;

        if (totalPages <= 1) return; // No pagination needed for 0 or 1 page

        // Previous Button
        paginationUl.innerHTML += `
            <li class="page-item ${pageData.first ? 'disabled' : ''}">
                <a class="page-link" href="#" aria-label="Previous" onclick="changePage(${currentPage - 1}); return false;">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>`;

        // Page Numbers (simplified example: show current, +/- 1, first, last)
        const maxPagesToShow = 5; // Adjust as needed
        let startPage = Math.max(0, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages - 1, startPage + maxPagesToShow - 1);
        // Adjust startPage if endPage is at the limit
        if (endPage === totalPages - 1) {
            startPage = Math.max(0, endPage - maxPagesToShow + 1);
        }


        if (startPage > 0) {
            paginationUl.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(0); return false;">1</a></li>`;
            if (startPage > 1) paginationUl.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }

        for (let i = startPage; i <= endPage; i++) {
            paginationUl.innerHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i + 1}</a>
                </li>`;
        }

        if (endPage < totalPages - 1) {
            if (endPage < totalPages - 2) paginationUl.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            paginationUl.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages - 1}); return false;">${totalPages}</a></li>`;
        }


        // Next Button
        paginationUl.innerHTML += `
            <li class="page-item ${pageData.last ? 'disabled' : ''}">
                <a class="page-link" href="#" aria-label="Next" onclick="changePage(${currentPage + 1}); return false;">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>`;
    }

    function changePage(page) {
        if (page < 0 || page >= totalPages) return;
        currentPage = page;
        loadCheckins(false); // Fetch data for the new page
    }

    // === C·∫¨P NH·∫¨T TH·ªêNG K√ä (ƒê√É B·ªä X√ìA) ===

    // === H√ÄM TI·ªÜN √çCH ===
    function showLoading() { document.getElementById('loadingSpinner').style.display = 'block'; }
    function hideLoading() { document.getElementById('loadingSpinner').style.display = 'none'; }
    function showEmptyStateIfNeeded() {
        const container = document.getElementById('checkinContainer');
        const emptyState = document.getElementById('emptyState');
        const paginationContainer = document.getElementById('paginationContainer');
        if (container.children.length === 0) {
            emptyState.classList.remove('d-none');
            paginationContainer.classList.add('d-none');
        } else {
            emptyState.classList.add('d-none');
            paginationContainer.classList.remove('d-none');
        }
    }
    function hideEmptyState() { document.getElementById('emptyState').classList.add('d-none'); }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            // Assuming dateString is 'YYYY-MM-DD'
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        } catch (e) {
            console.warn("L·ªói format ng√†y:", dateString);
            return dateString; // Return original if format fails
        }
    }
    function calculateNights(checkinStr, checkoutStr) {
        try {
            const checkin = new Date(checkinStr + 'T00:00:00');
            const checkout = new Date(checkoutStr + 'T00:00:00');
            const diffTime = Math.abs(checkout - checkin);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 1; // Ensure at least 1 night
        } catch (e) {
            return '?';
        }
    }
    function formatCurrency(amount) {
        if (amount == null || isNaN(amount)) return '0 VNƒê';
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }
    function getCheckinStatusBadgeClass(status) { // Status here is 'pending' or 'overdue'
        return status === 'overdue' ? 'bg-danger' : 'bg-warning';
    }
    function getCheckinStatusText(status) { // Status here is 'pending' or 'overdue'
        return status === 'overdue' ? 'Qu√° h·∫°n' : 'Ch·ªù check-in';
    }
    function getStatusText(apiStatus) { // For detail modal using API status
        const texts = {
            'PENDING': 'ƒêang ch·ªù', 'CONFIRMED': 'ƒê√£ x√°c nh·∫≠n', 'CHECKED_IN': 'ƒê√£ check-in',
            'CHECKED_OUT': 'ƒê√£ check-out', 'CANCELLED': 'ƒê√£ h·ªßy'
        };
        return texts[apiStatus] || apiStatus;
    }

    function getInitials(name) {
        if (!name) return '?';
        return name.split(' ').map(w => w ? w[0] : '').join('').toUpperCase().slice(0, 2);
    }
    function getAvatarColor(initials) {
        const colors = ['bg-primary', 'bg-success', 'bg-warning', 'bg-info', 'bg-danger', 'bg-secondary', 'bg-dark'];
        // Simple hash function for consistent color based on initials
        let hash = 0;
        for (let i = 0; i < initials.length; i++) {
            hash = initials.charCodeAt(i) + ((hash << 5) - hash);
        }
        const index = Math.abs(hash % colors.length);
        return colors[index];
    }
    function showAlert(message, type = 'info') { // Default to 'info'
        const existingAlert = document.getElementById('dynamicAlert');
        if(existingAlert) existingAlert.remove();

        const alert = document.createElement('div');
        alert.id = 'dynamicAlert';
        alert.className = `alert alert-${type} alert-dismissible fade show alert-custom`;
        alert.setAttribute('role', 'alert');
        alert.innerHTML = `
            <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : type === 'warning' ? 'bi-exclamation-triangle-fill' : type === 'danger' ? 'bi-exclamation-octagon-fill' : 'bi-info-circle-fill'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(alert);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            const currentAlert = document.getElementById('dynamicAlert');
            if (currentAlert) {
                bootstrap.Alert.getOrCreateInstance(currentAlert).close();
            }
        }, 5000);
    }

    // H√ÄM fetchWithAuth (ƒê∆∞·ª£c g·ªçi b·ªüi c√°c h√†m kh√°c)
    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            console.error('Kh√¥ng t√¨m th·∫•y token. ƒêang chuy·ªÉn v·ªÅ trang ƒëƒÉng nh·∫≠p.');
            alert('Phi√™n ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
            window.location.href = '/HotelAdmin/pages-login.html';
            throw new Error('Ch∆∞a ƒëƒÉng nh·∫≠p');
        }

        const headers = new Headers(options.headers || {});
        // Th√™m Content-Type n·∫øu l√† POST/PUT/PATCH v√† c√≥ body
        if (options.body && !headers.has('Content-Type')) {
            headers.append('Content-Type', 'application/json');
        }
        headers.append('Authorization', `Bearer ${token}`);

        const updatedOptions = { ...options, headers: headers };
        const response = await fetch(url, updatedOptions);

        if (response.status === 401 || response.status === 403) {
            console.error('L·ªói 401/403. Token c√≥ th·ªÉ h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá.');
            alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
            localStorage.removeItem('jwtToken');
            window.location.href = '/HotelAdmin/pages-login.html';
            throw new Error('Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n');
        }
        return response;
    }
</script>
</body>
</html>