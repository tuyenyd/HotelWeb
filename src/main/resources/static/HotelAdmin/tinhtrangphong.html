<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Tình trạng phòng - HotelAdmin</title>
    <link href="assets/img/img.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
    <style>
        .floor-plan {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .room-status {
            width: 80px;
            height: 80px;
            margin: 10px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .room-status:hover {
            transform: scale(1.1);
        }
        .room-available {
            background: #0dcaf0;
        }
        .room-occupied {
            background: #198754;
        }
        .room-maintenance {
            background: #dc3545;
        }
        .room-cleaning {
            background: #ffc107;
            color: #000;
        }
        .room-reserved {
            background: #6f42c1;
        }
        .status-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
        }
        .floor-title {
            border-bottom: 2px solid #4154f1;
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: #4154f1;
        }
    </style>
</head>
<body>

<!-- ======= Header ======= -->
<header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
        <a href="index.html" class="logo d-flex align-items-center">
            <img src="assets/img/logo.png" alt="Logo">
            <span class="d-none d-lg-block">Hotel</span>
        </a>
        <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><div class="search-bar">
    <form class="search-form d-flex align-items-center" method="POST" action="#">
        <input type="text" name="query" placeholder="Tìm kiếm đặt phòng, khách hàng..." title="Nhập từ khóa tìm kiếm">
        <button type="submit" title="Tìm kiếm"><i class="bi bi-search"></i></button>
    </form>
</div><nav class="header-nav ms-auto">
    <ul class="d-flex align-items-center">

        <li class="nav-item d-block d-lg-none">
            <a class="nav-link nav-icon search-bar-toggle " href="#">
                <i class="bi bi-search"></i>
            </a>
        </li><li class="nav-item dropdown">
        <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-bell"></i>
            <span class="badge bg-primary badge-number">3</span>
        </a><ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications">
        <li class="dropdown-header">
            Bạn có 3 thông báo mới
            <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">Xem tất cả</span></a>
        </li>
        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-exclamation-circle text-warning"></i>
            <div>
                <h4>Đặt phòng mới</h4>
                <p>Khách hàng Nguyễn Văn A vừa đặt phòng Deluxe</p>
                <p>5 phút trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-x-circle text-danger"></i>
            <div>
                <h4>Hủy đặt phòng</h4>
                <p>Đặt phòng #2457 đã bị hủy</p>
                <p>2 giờ trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-check-circle text-success"></i>
            <div>
                <h4>Phản hồi mới</h4>
                <p>Bạn có 2 đánh giá mới từ khách hàng</p>
                <p>4 giờ trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>
        <li class="dropdown-footer">
            <a href="#">Hiển thị tất cả thông báo</a>
        </li>
    </ul></li><li class="nav-item dropdown pe-3">

        <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <img src="assets/img/profile-img.jpg" alt="Hồ sơ" class="rounded-circle">
            <span class="d-none d-md-block dropdown-toggle ps-2" id="profileName">Đang tải...</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li class="dropdown-header">
                <h6 id="profileDropdownName">...</h6>
                <span id="profileDropdownRole">...</span>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                    <i class="bi bi-person"></i>
                    <span>Hồ sơ của tôi</span>
                </a>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                    <i class="bi bi-gear"></i>
                    <span>Cài đặt tài khoản</span>
                </a>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="#" id="logoutButton">
                    <i class="bi bi-box-arrow-right"></i>
                    <span>Đăng xuất</span>
                </a>
            </li>
        </ul></li></ul>
</nav>
</header><!-- Kết thúc Header -->

<!-- ======= Sidebar ======= -->
<aside id="sidebar" class="sidebar">

    <ul class="sidebar-nav" id="sidebar-nav">

        <li class="nav-item">
            <a class="nav-link " href="index.html">
                <i class="bi bi-house-door"></i>
                <span>Bảng Điều Khiển</span>
            </a>
        </li><!-- Kết thúc Điều hướng Bảng Điều Khiển -->

        <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#booking-nav" data-bs-toggle="collapse" href="#">
                <i class="bi bi-calendar-check"></i><span>Quản lý Đặt phòng</span><i class="bi bi-chevron-down ms-auto"></i>
            </a>
            <ul id="booking-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
                <li>
                    <a href="tatcadatphong.html">
                        <i class="bi bi-circle"></i><span>Tất cả đặt phòng</span>
                    </a>
                </li>
                <li>
                    <a href="checkin.html">
                        <i class="bi bi-circle"></i><span>Check-in</span>
                    </a>
                </li>
                <li>
                    <a href="checkout.html">
                        <i class="bi bi-circle"></i><span>Check-out</span>
                    </a>
                </li>
            </ul>
        </li><!-- Kết thúc Điều hướng Đặt phòng -->

        <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#room-nav" data-bs-toggle="collapse" href="#">
                <i class="bi bi-door-closed"></i><span>Quản lý Phòng</span><i class="bi bi-chevron-down ms-auto"></i>
            </a>
            <ul id="room-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
                <li>
                    <a href="danhsachphong.html">
                        <i class="bi bi-circle"></i><span>Danh sách phòng</span>
                    </a>
                </li>
                <li>
                    <a href="loaiphong.html">
                        <i class="bi bi-circle"></i><span>Loại phòng</span>
                    </a>
                </li>
                <li>
                    <a href="tinhtrangphong.html">
                        <i class="bi bi-circle"></i><span>Tình trạng phòng</span>
                    </a>
                </li>
                <li>
                    <a href="giaphong.html">
                        <i class="bi bi-circle"></i><span>Giá phòng</span>
                    </a>
                </li>
            </ul>
        </li><!-- Kết thúc Điều hướng Phòng -->

        <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#customer-nav" data-bs-toggle="collapse" href="#">
                <i class="bi bi-people"></i><span>Quản lý Khách hàng</span><i class="bi bi-chevron-down ms-auto"></i>
            </a>
            <ul id="customer-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
                <li>
                    <a href="danhsachkhachhang.html">
                        <i class="bi bi-circle"></i><span>Danh sách khách hàng</span>
                    </a>
                </li>
                <li>
                    <a href="chuongtrinhthanhvien.html">
                        <i class="bi bi-circle"></i><span>Chương trình thành viên</span>
                    </a>
                </li>
                <li>
                    <a href="danhgia&phanhoi.html">
                        <i class="bi bi-circle"></i><span>Đánh giá & Phản hồi</span>
                    </a>
                </li>
            </ul>
        </li><!-- Kết thúc Điều hướng Khách hàng -->

        <li class="nav-item">
            <a class="nav-link collapsed" href="baocao&thongke.html">
                <i class="bi bi-bar-chart"></i>
                <span>Báo cáo & Thống kê</span>
            </a>
        </li><!-- Kết thúc Điều hướng Báo cáo -->
        <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#finance-nav" data-bs-toggle="collapse" href="#">
                <i class="bi bi-cash-coin"></i><span>Tài chính</span><i class="bi bi-chevron-down ms-auto"></i>
            </a>
            <ul id="finance-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
                <li>
                    <a href="finance-invoices.html">
                        <i class="bi bi-circle"></i><span>Hóa đơn</span>
                    </a>
                </li>
                <li>
                    <a href="finance-payments.html">
                        <i class="bi bi-circle"></i><span>Thanh toán</span>
                    </a>
                </li>
                <li>
                    <a href="finance-revenue.html">
                        <i class="bi bi-circle"></i><span>Doanh thu</span>
                    </a>
                </li>
            </ul>
        </li><!-- Kết thúc Điều hướng Tài chính -->

        <li class="nav-heading">Trang</li>

        <li class="nav-item">
            <a class="nav-link collapsed" href="users-profile.html">
                <i class="bi bi-person"></i>
                <span>Hồ sơ</span>
            </a>
        </li><!-- Kết thúc Trang Hồ sơ -->

        <li class="nav-item">
            <a class="nav-link collapsed" href="pages-contact.html">
                <i class="bi bi-envelope"></i>
                <span>Liên hệ</span>
            </a>
        </li><!-- Kết thúc Trang Liên hệ -->
        <li class="nav-item">
            <a class="nav-link collapsed" href="users.html">
                <i class="bi bi-person-gear"></i>
                <span>Nhân viên</span>
            </a>
        </li>

        <li class="nav-item">
            <a class="nav-link collapsed" href="taikhoan.html">
                <i class="bi bi-person-badge"></i>
                <span>Tài khoản</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" href="settings.html">
                <i class="bi bi-gear"></i>
                <span>Cài đặt</span>
            </a>
        </li>
    </ul>

</aside><!-- Kết thúc Sidebar -->
<main id="main" class="main">
    <div class="pagetitle d-flex justify-content-between align-items-center">
        <h1>Tình trạng phòng</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
                <li class="breadcrumb-item">Quản lý Phòng</li>
                <li class="breadcrumb-item active">Tình trạng phòng</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Tổng quan tình trạng phòng</h5>

                        <div class="status-legend">
                            <div class="legend-item">
                                <div class="legend-color room-available"></div>
                                <span>Trống</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color room-occupied"></div>
                                <span>Đang sử dụng</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color room-reserved"></div>
                                <span>Đã đặt trước</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color room-cleaning"></div>
                                <span>Đang dọn dẹp</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color room-maintenance"></div>
                                <span>Bảo trì</span>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <input type="date" class="form-control" id="filterDate" value="2024-06-15">
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="filterFloor">
                                    <option value="all" selected>Tất cả các tầng</option>
                                    <option value="1">Tầng 1</option>
                                    <option value="2">Tầng 2</option>
                                    <option value="3">Tầng 3</option>
                                </select>
                            </div>
                        </div>

                        <div id="floorContainer"></div>

                        <div class="modal fade" id="roomDetailModal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Chi tiết phòng</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="roomDetailForm" data-room-id="">
                                            <div class="mb-3">
                                                <label class="form-label">Số phòng</label>
                                                <input type="text" class="form-control" name="roomNumber" readonly>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Loại phòng</label>
                                                <input type="text" class="form-control" name="roomType" readonly>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Trạng thái</label>
                                                <select class="form-select" name="roomStatus">
                                                    <option value="AVAILABLE">Trống</option>
                                                    <option value="OCCUPIED">Đang sử dụng</option>
                                                    <option value="RESERVED">Đã đặt trước</option>
                                                    <option value="CLEANING">Đang dọn dẹp</option>
                                                    <option value="MAINTENANCE">Bảo trì</option>
                                                </select>
                                            </div>
                                        </form>
                                        <div id="roomDetailAlert" class="alert alert-success d-none mt-2">Cập nhật thành công!</div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                        <button type="button" class="btn btn-primary" id="btnUpdateRoomDetail">Cập nhật</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
<footer id="footer" class="footer">
    <div class="copyright">
        &copy; Bản quyền <strong><span>HotelAdmin</span></strong>. Tất cả các quyền được bảo lưu
    </div>
    <div class="credits">
        Thiết kế bởi <a href="#">Nhóm Phát triển</a>
    </div>
</footer>

<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/main.js"></script>
<script src="assets/js/auth.js"></script>

<script>

    // Dữ liệu phòng sẽ được tải từ API
    let allRoomData = [];
    let allFloors = new Set(); // Dùng để tự động điền bộ lọc tầng

    // Hàm mới để tải dữ liệu phòng
    async function fetchRoomData() {
        try {
            const response = await fetchWithAuth('/api/admin/rooms'); // Sử dụng API endpoint
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            allRoomData = await response.json();

            // Cập nhật danh sách các tầng từ dữ liệu
            allFloors.clear();
            allRoomData.forEach(room => allFloors.add(room.floor));
            updateFloorFilter();

            console.log("Tải dữ liệu phòng thành công:", allRoomData);
        } catch (error) {
            console.error('Lỗi khi tải danh sách phòng:', error);
            alert('Không thể tải dữ liệu phòng. Vui lòng thử lại.');
        }
    }

    // Hàm cập nhật bộ lọc tầng
    function updateFloorFilter() {
        const filterSelect = document.getElementById('filterFloor');
        filterSelect.innerHTML = '<option value="all" selected>Tất cả các tầng</option>';

        // Sắp xếp các tầng và thêm vào
        [...allFloors].sort((a, b) => a - b).forEach(floorNum => {
            filterSelect.innerHTML += `<option value="${floorNum}">Tầng ${floorNum}</option>`;
        });
    }

    // Render các tầng và phòng
    function renderFloors(selectedFloor = 'all') {
        const container = document.getElementById('floorContainer');
        container.innerHTML = '';

        // Lấy danh sách tầng duy nhất từ dữ liệu đã tải, đã sắp xếp
        const floorsToRender = [...allFloors].sort((a, b) => a - b);

        floorsToRender.forEach(floor => {
            if (selectedFloor !== 'all' && selectedFloor != floor) return;

            // SỬA: Lọc từ allRoomData
            const rooms = allRoomData.filter(r => r.floor === floor);
            if(rooms.length === 0) return; // Bỏ qua nếu tầng không có phòng (sau khi lọc)

            // SỬA: Lấy tên loại phòng từ phòng đầu tiên (nếu có)
            let type = rooms.length ? (rooms[0].roomTypeName || 'N/A') : '';
            let title = `Tầng ${floor}` + (type ? ` - (${type}...)` : ''); // Cập nhật tiêu đề

            let html = `<div class="floor-plan">
                <h4 class="floor-title">${title}</h4>
                <div class="text-center">`;

            // Nhóm các phòng, 5 phòng mỗi hàng
            const roomsInFloor = rooms.sort((a,b) => a.roomNumber.localeCompare(b.roomNumber));
            for (let i = 0; i < roomsInFloor.length; i += 5) {
                html += `<div class="mb-3">`;
                roomsInFloor.slice(i, i + 5).forEach(room => {
                    let statusKey = room.status.toLowerCase();
                    let statusText = 'N/A';
                    // SỬA: Đồng bộ tên trạng thái với CSS class
                    switch (room.status) {
                        case 'AVAILABLE': statusText = 'Trống'; statusKey = 'available'; break;
                        case 'OCCUPIED': statusText = 'Đang sử dụng'; statusKey = 'occupied'; break;
                        case 'CLEANING': statusText = 'Đang dọn dẹp'; statusKey = 'cleaning'; break;
                        case 'MAINTENANCE': statusText = 'Bảo trì'; statusKey = 'maintenance'; break;
                        case 'RESERVED': statusText = 'Đã đặt trước'; statusKey = 'reserved'; break;
                    }

                    // SỬA: Dùng room.roomTypeName và room.roomNumber
                    let tooltip = `Phòng ${room.roomNumber} - ${room.roomTypeName || 'N/A'} - ${statusText}`;

                    html += `<div class="room-status room-${statusKey}"
                        data-bs-toggle="tooltip"
                        title="${tooltip}"
                        data-room="${room.roomNumber}"
                        style="user-select:none;">
                        ${room.roomNumber}
                    </div>`;
                });
                html += `</div>`;
            }
            html += `</div></div>`;
            container.innerHTML += html;
        });

        // Khởi tạo lại tooltip
        setTimeout(() => {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            tooltipTriggerList.forEach(el => {
                if (el._tooltip) el._tooltip.dispose();
                el._tooltip = new bootstrap.Tooltip(el);
            });
        }, 100);

        // Gán sự kiện click phòng
        document.querySelectorAll('.room-status').forEach(el => {
            el.onclick = function() {
                openRoomDetailModal(this.getAttribute('data-room'));
            };
        });
    }

    // Mở modal chi tiết phòng
    function openRoomDetailModal(roomNumber) {
        // SỬA: Tìm phòng trong allRoomData bằng roomNumber
        const room = allRoomData.find(r => r.roomNumber === roomNumber);
        if (!room) return;

        const modal = document.getElementById('roomDetailModal');
        const form = document.getElementById('roomDetailForm');

        // SỬA: Điền dữ liệu từ đối tượng room (API)
        form.roomNumber.value = room.roomNumber;
        form.roomType.value = room.roomTypeName || 'N/A'; // Dùng roomTypeName
        form.roomStatus.value = room.status; // Dùng status (API trả về 'AVAILABLE', 'OCCUPIED'...)

        // SỬA: Lưu ID của phòng vào dataset của form để dùng khi cập nhật
        form.dataset.roomId = room.id;

        document.getElementById('roomDetailAlert').classList.add('d-none');
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }

    // Cập nhật trạng thái phòng (PHIÊN BẢN API)
    async function handleUpdateRoomDetail() {
        const form = document.getElementById('roomDetailForm');
        const roomId = form.dataset.roomId; // Lấy ID từ dataset
        const newStatus = form.roomStatus.value;

        // Tìm phòng gốc trong dữ liệu local để lấy thông tin đầy đủ
        const originalRoom = allRoomData.find(r => r.id == roomId);
        if (!originalRoom) {
            alert("Lỗi: Không tìm thấy thông tin phòng gốc.");
            return;
        }

        // Tạo payload (đối tượng dữ liệu) để gửi đi,
        // giống hệt cấu trúc update của danhsachphong.html
        const roomUpdatePayload = {
            roomNumber: originalRoom.roomNumber,
            floor: originalRoom.floor,
            roomTypeId: originalRoom.roomTypeId,
            status: newStatus, // Đây là giá trị mới
            pricePerNight: originalRoom.pricePerNight
        };

        try {
            // SỬA: Gọi API để cập nhật
            const response = await fetchWithAuth(`/api/admin/rooms/${roomId}`, {
                method: 'PUT',
                body: JSON.stringify(roomUpdatePayload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Có lỗi xảy ra khi cập nhật');
            }

            // Cập nhật thành công

            // 1. Cập nhật dữ liệu local
            originalRoom.status = newStatus;

            // 2. Hiển thị thông báo
            document.getElementById('roomDetailAlert').classList.remove('d-none');

            // 3. Render lại giao diện
            renderFloors(document.getElementById('filterFloor').value);

            // 4. Đóng modal sau 0.8s
            setTimeout(() => {
                const modal = document.getElementById('roomDetailModal');
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            }, 800);

        } catch (error) {
            console.error('Lỗi khi cập nhật trạng thái phòng:', error);
            alert('Lỗi: ' + error.message);
            document.getElementById('roomDetailAlert').classList.add('d-none');
        }
    }

    // Sự kiện bộ lọc
    document.addEventListener('DOMContentLoaded', async function() {
        // SỬA: Tải dữ liệu trước khi render
        await fetchRoomData();

        // Render lần đầu với dữ liệu đã tải
        renderFloors();

        // **SỬA ĐỔI: Xóa bỏ dòng tham chiếu đến 'btnUpdateFilter' không tồn tại**
        // document.getElementById('btnUpdateFilter').onclick = function() {
        //     renderFloors(document.getElementById('filterFloor').value);
        // };

        // Sự kiện 'onchange' này đã xử lý việc lọc theo tầng
        document.getElementById('filterFloor').onchange = function() {
            renderFloors(this.value);
        };

        // Gán sự kiện cho nút cập nhật (đã đổi thành hàm async)
        document.getElementById('btnUpdateRoomDetail').onclick = handleUpdateRoomDetail;
    });
</script>

</body>
</html>