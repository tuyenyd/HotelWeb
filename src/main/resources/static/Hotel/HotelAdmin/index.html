<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>Dashboard - Quản lý Khách sạn</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <link href="assets/img/img.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
    <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
    <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet"> <link href="assets/css/style.css" rel="stylesheet">
</head>

<body>

<header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
        <a href="index.html" class="logo d-flex align-items-center">
            <img src="assets/img/logo.png" alt="Logo">
            <span class="d-none d-lg-block">Grandoria</span>
        </a>
        <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><div class="search-bar">
    <form class="search-form d-flex align-items-center" method="POST" action="#">
        <input type="text" name="query" placeholder="Tìm kiếm đặt phòng, khách hàng..." title="Nhập từ khóa tìm kiếm">
        <button type="submit" title="Tìm kiếm"><i class="bi bi-search"></i></button>
    </form>
</div><nav class="header-nav ms-auto">
    <ul class="d-flex align-items-center">

        <li class="nav-item d-block d-lg-none">
            <a class="nav-link nav-icon search-bar-toggle " href="#">
                <i class="bi bi-search"></i>
            </a>
        </li><li class="nav-item dropdown">
        <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-bell"></i>
            <span class="badge bg-primary badge-number">3</span>
        </a><ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications">
        <li class="dropdown-header">
            Bạn có 3 thông báo mới
            <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">Xem tất cả</span></a>
        </li>
        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-exclamation-circle text-warning"></i>
            <div>
                <h4>Đặt phòng mới</h4>
                <p>Khách hàng Nguyễn Văn A vừa đặt phòng Deluxe</p>
                <p>5 phút trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-x-circle text-danger"></i>
            <div>
                <h4>Hủy đặt phòng</h4>
                <p>Đặt phòng #2457 đã bị hủy</p>
                <p>2 giờ trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-check-circle text-success"></i>
            <div>
                <h4>Phản hồi mới</h4>
                <p>Bạn có 2 đánh giá mới từ khách hàng</p>
                <p>4 giờ trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>
        <li class="dropdown-footer">
            <a href="#">Hiển thị tất cả thông báo</a>
        </li>
    </ul></li><li class="nav-item dropdown pe-3">

        <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <img src="assets/img/profile-img.jpg" alt="Hồ sơ" class="rounded-circle">
            <span class="d-none d-md-block dropdown-toggle ps-2" id="profileName">Đang tải...</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li class="dropdown-header">
                <h6 id="profileDropdownName">...</h6>
                <span id="profileDropdownRole">...</span>
            </li>
        <li>
            <hr class="dropdown-divider">
        </li>

        <li>
            <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                <i class="bi bi-person"></i>
                <span>Hồ sơ của tôi</span>
            </a>
        </li>
        <li>
            <hr class="dropdown-divider">
        </li>

        <li>
            <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                <i class="bi bi-gear"></i>
                <span>Cài đặt tài khoản</span>
            </a>
        </li>
        <li>
            <hr class="dropdown-divider">
        </li>

        <li>
            <a class="dropdown-item d-flex align-items-center" href="pages-login.html" id="logoutButton">
                <i class="bi bi-box-arrow-right"></i>
                <span>Đăng xuất</span>
            </a>
        </li>
    </ul></li></ul>
</nav></header><aside id="sidebar" class="sidebar">

    <ul class="sidebar-nav" id="sidebar-nav">

        <li class="nav-item">
            <a class="nav-link " href="index.html">
                <i class="bi bi-house-door"></i>
                <span>Bảng Điều Khiển</span>
            </a>
        </li><li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#booking-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-calendar-check"></i><span>Quản lý Đặt phòng</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="booking-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
            <li>
                <a href="tatcadatphong.html">
                    <i class="bi bi-circle"></i><span>Tất cả đặt phòng</span>
                </a>
            </li>
            <li>
                <a href="checkin.html">
                    <i class="bi bi-circle"></i><span>Check-in</span>
                </a>
            </li>
            <li>
                <a href="checkout.html">
                    <i class="bi bi-circle"></i><span>Check-out</span>
                </a>
            </li>
        </ul>
    </li><li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#room-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-door-closed"></i><span>Quản lý Phòng</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="room-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
            <li>
                <a href="danhsachphong.html">
                    <i class="bi bi-circle"></i><span>Danh sách phòng</span>
                </a>
            </li>
            <li>
                <a href="loaiphong.html">
                    <i class="bi bi-circle"></i><span>Loại phòng</span>
                </a>
            </li>
            <li>
                <a href="tinhtrangphong.html">
                    <i class="bi bi-circle"></i><span>Tình trạng phòng</span>
                </a>
            </li>
            <li>
                <a href="giaphong.html">
                    <i class="bi bi-circle"></i><span>Giá phòng</span>
                </a>
            </li>
        </ul>
    </li><li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#customer-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-people"></i><span>Quản lý Khách hàng</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="customer-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
            <li>
                <a href="danhsachkhachhang.html">
                    <i class="bi bi-circle"></i><span>Danh sách khách hàng</span>
                </a>
            </li>
            <li>
                <a href="chuongtrinhthanhvien.html">
                    <i class="bi bi-circle"></i><span>Chương trình thành viên</span>
                </a>
            </li>
            <li>
                <a href="danhgia&phanhoi.html">
                    <i class="bi bi-circle"></i><span>Đánh giá & Phản hồi</span>
                </a>
            </li>
        </ul>
    </li><li class="nav-item">
        <a class="nav-link collapsed" href="baocao&thongke.html">
            <i class="bi bi-bar-chart"></i>
            <span>Báo cáo & Thống kê</span>
        </a>
    </li><li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#finance-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-cash-coin"></i><span>Tài chính</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="finance-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
            <li>
                <a href="finance-invoices.html">
                    <i class="bi bi-circle"></i><span>Hóa đơn</span>
                </a>
            </li>
            <li>
                <a href="finance-payments.html">
                    <i class="bi bi-circle"></i><span>Thanh toán</span>
                </a>
            </li>
            <li>
                <a href="finance-revenue.html">
                    <i class="bi bi-circle"></i><span>Doanh thu</span>
                </a>
            </li>
        </ul>
    </li><li class="nav-heading">Trang</li>

        <li class="nav-item">
            <a class="nav-link collapsed" href="users-profile.html">
                <i class="bi bi-person"></i>
                <span>Hồ sơ</span>
            </a>
        </li><li class="nav-item">
        <a class="nav-link collapsed" href="pages-contact.html">
            <i class="bi bi-envelope"></i>
            <span>Liên hệ</span>
        </a>
    </li><li class="nav-item">
        <a class="nav-link collapsed" href="users.html">
            <i class="bi bi-person-gear"></i>
            <span>Nhân viên</span>
        </a>
    </li>

        <li class="nav-item">
            <a class="nav-link collapsed" href="taikhoan.html">
                <i class="bi bi-person-badge"></i>
                <span>Tài khoản</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" href="settings.html">
                <i class="bi bi-gear"></i>
                <span>Cài đặt</span>
            </a>
        </li>
    </ul>

</aside>
<main id="main" class="main">

    <div class="pagetitle d-flex justify-content-between align-items-center">
        <h1>Bảng Điều Khiển</h1>
        <nav>
            <ol class="breadcrumb ">
                <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
                <li class="breadcrumb-item active">Bảng Điều Khiển</li>
            </ol>
        </nav>
    </div>
    <section class="section dashboard">
        <div class="row">

            <div class="col-lg-8">
                <div class="row">

                    <div class="col-12">
                        <div class="card">
                            <div class="filter">
                                <a class="icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
                                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                    <li class="dropdown-header text-start">
                                        <h6>Lọc</h6>
                                    </li>
                                    <li><a class="dropdown-item" href="#">Hôm nay</a></li>
                                    <li><a class="dropdown-item" href="#">Tháng này</a></li>
                                    <li><a class="dropdown-item" href="#">Năm nay</a></li>
                                </ul>
                            </div>

                            <div class="card-body">
                                <h5 class="card-title">Báo cáo Doanh thu <span>/Năm nay</span></h5>
                                <div id="revenueChart"></div>
                            </div>
                        </div>
                    </div><div class="col-12">
                    <div class="card recent-sales overflow-auto">
                        <div class="filter">
                            <a class="icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                <li class="dropdown-header text-start">
                                    <h6>Lọc</h6>
                                </li>
                                <li><a class="dropdown-item" href="#">Hôm nay</a></li>
                                <li><a class="dropdown-item" href="#">Tháng này</a></li>
                                <li><a class="dropdown-item" href="#">Năm nay</a></li>
                            </ul>
                        </div>

                        <div class="card-body">
                            <h5 class="card-title">Đặt phòng Gần đây <span>| 5 gần nhất</span></h5>
                            <table class="table table-borderless datatable" id="recentBookingsTable">
                                <thead>
                                <tr>
                                    <th scope="col">Mã</th>
                                    <th scope="col">Khách hàng</th>
                                    <th scope="col">Phòng</th>
                                    <th scope="col">Ngày</th>
                                    <th scope="col">Trạng thái</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr><td colspan="5" class="text-center">Đang tải...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div></div>
            </div><div class="col-lg-4">

            <div class="card">
                <div class="filter">
                    <a class="icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                        <li class="dropdown-header text-start">
                            <h6>Lọc</h6>
                        </li>
                        <li><a class="dropdown-item" href="#">Tất cả</a></li>
                        <li><a class="dropdown-item" href="#">Sẵn sàng</a></li>
                        <li><a class="dropdown-item" href="#">Đang sử dụng</a></li>
                    </ul>
                </div>

                <div class="card-body">
                    <h5 class="card-title">Tình trạng Phòng <span>| Hiện tại</span></h5>
                    <div id="roomStatusChart" style="min-height: 400px;" class="echart"></div>
                </div>
            </div><div class="card">
            <div class="card-body">
                <h5 class="card-title">Check-in/Check-out <span>| Hôm nay</span></h5>
                <div class="activity">
                    <div class="activity-item d-flex"><div class="text-muted">Đang tải...</div></div>
                </div>
            </div>
        </div><div class="card">
            <div class="filter">
                <a class="icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                    <li class="dropdown-header text-start">
                        <h6>Lọc</h6>
                    </li>
                    <li><a class="dropdown-item" href="#">Hôm nay</a></li>
                    <li><a class="dropdown-item" href="#">Tuần này</a></li>
                    <li><a class="dropdown-item" href="#">Tháng này</a></li>
                </ul>
            </div>

            <div class="card-body pb-0">
                <h5 class="card-title">Đánh giá Mới <span>| Tuần này</span></h5>
                <div class="news">
                    <div class="post-item clearfix">
                        <div class="rating">
                            <i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star text-warning"></i>
                        </div>
                        <h4><a href="#">Trải nghiệm tuyệt vời</a></h4>
                        <p>Phòng sạch sẽ, nhân viên nhiệt tình...</p><small>- Nguyễn Văn A</small>
                    </div>
                    <div class="post-item clearfix">
                        <div class="rating"><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i></div>
                        <h4><a href="#">Hoàn hảo!</a></h4>
                        <p>Dịch vụ 5 sao, vị trí thuận tiện...</p><small>- Trần Thị B</small>
                    </div>
                </div>
            </div>
        </div></div></div>
    </section>

</main><footer id="footer" class="footer">
    <div class="copyright">
        &copy; Bản quyền <strong><span>HotelAdmin</span></strong>. Tất cả các quyền được bảo lưu
    </div>
    <div class="credits">
        Thiết kế bởi <a href="#">Nhóm Phát triển</a>
    </div>
</footer><a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

<script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="assets/vendor/chart.js/chart.umd.js"></script>
<script src="assets/vendor/echarts/echarts.min.js"></script>
<script src="assets/vendor/quill/quill.js"></script>
<script src="assets/vendor/simple-datatables/simple-datatables.js"></script> <script src="assets/vendor/tinymce/tinymce.min.js"></script>
<script src="assets/vendor/php-email-form/validate.js"></script>

<script src="assets/js/main.js"></script>
<script src="assets/js/auth.js"></script>
<script>
    // === CẤU HÌNH VÀ BIẾN TOÀN CỤC ===
    const API_BASE_URL = '/api/admin'; // Địa chỉ gốc API
    let allBookings = [];
    let allCustomers = [];
    let allRooms = [];
    // Dữ liệu tổng hợp (chủ yếu cho biểu đồ doanh thu)
    let aggregatedDashboardData = { revenueChart: null };

    // Biến cho biểu đồ
    let revenueChartInstance = null;
    let roomStatusChartInstance = null;
    let datatableInstance = null; // Biến cho SimpleDatatables

    // Biến theo dõi trạng thái chuyển hướng

    document.addEventListener('DOMContentLoaded', async () => {
        console.log("DOM đã tải. Bắt đầu khởi tạo dashboard...");
        showLoadingState(true);
        try {
            if (!localStorage.getItem('jwtToken')) throw new Error("Chưa đăng nhập.");

            // ⭐ SỬA 4: Chạy các hàm mới
            loadProfileFromStorage(); // Tải profile từ localStorage
            setupLogoutButton();      // Gắn sự kiện cho nút đăng xuất

            await fetchDashboardData();
            initializeCharts();
            updateDashboard();
            console.log("Khởi tạo dashboard thành công.");
        } catch (error) {
            console.error(">>> LỖI NGHIÊM TRỌNG KHI KHỞI TẠO DASHBOARD:", error);
            const mainElement = document.querySelector('#main');
            if (mainElement) {
                mainElement.insertAdjacentHTML('afterbegin', `<div class="alert alert-danger alert-dismissible fade show" role="alert" style="position: sticky; top: 60px; z-index: 1050;"><i class="bi bi-exclamation-octagon me-1"></i><strong>Lỗi tải dữ liệu Dashboard!</strong> ${error.message}. Kiểm tra Console (F12).<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);
            }
            // Ẩn các phần tử có thể lỗi
            document.querySelector('#revenueChart')?.classList.add('d-none'); document.querySelector('#roomStatusChart')?.classList.add('d-none'); document.querySelector('#recentBookingsTable')?.closest('.card')?.classList.add('d-none'); document.querySelector('.activity')?.closest('.card')?.classList.add('d-none');
        } finally {
            showLoadingState(false);
        }
    });



    // === TẢI DỮ LIỆU (Giữ nguyên, lấy 1000 booking) ===
    async function fetchDashboardData() {
        console.log("Bắt đầu tải dữ liệu...");
        let bookingsData, customersData, roomsData;
        try {
            const bookingsPromise = fetchWithAuth(`${API_BASE_URL}/bookings?page=0&size=1000&sort=createdDate,desc`);
            const customersPromise = fetchWithAuth(`${API_BASE_URL}/customers`);
            const roomsPromise = fetchWithAuth(`${API_BASE_URL}/rooms`);
            const [bookingsResponse, customersResponse, roomsResponse] = await Promise.all([ bookingsPromise, customersPromise, roomsPromise ]);

            try { bookingsData = await bookingsResponse.json(); allBookings = bookingsData?.content || []; if (!Array.isArray(allBookings)) throw new Error("Dữ liệu bookings không phải mảng."); console.log(`Tải ${allBookings.length} bookings.`); } catch (e) { throw new Error(`Lỗi JSON đặt phòng: ${e.message}`); }
            try { customersData = await customersResponse.json(); allCustomers = Array.isArray(customersData) ? customersData : []; if (!Array.isArray(allCustomers)) throw new Error("Dữ liệu customers không phải mảng."); console.log(`Tải ${allCustomers.length} customers.`); } catch (e) { throw new Error(`Lỗi JSON khách hàng: ${e.message}`); }
            try { roomsData = await roomsResponse.json(); allRooms = Array.isArray(roomsData) ? roomsData : []; if (!Array.isArray(allRooms)) throw new Error("Dữ liệu rooms không phải mảng."); console.log(`Tải ${allRooms.length} rooms.`); } catch (e) { throw new Error(`Lỗi JSON phòng: ${e.message}`); }

            // Chỉ cần xử lý dữ liệu cho biểu đồ doanh thu
            if (allBookings.length > 0) {
                processBookingDataForChart(); // <--- CHỈ XỬ LÝ CHO BIỂU ĐỒ
            } else {
                console.warn("Không có dữ liệu booking để xử lý.");
                aggregatedDashboardData = { revenueChart: { categories: Array(12).fill(0).map((_,i)=>`Th${i+1}`), series: [{ name: 'Doanh thu', data: Array(12).fill(0) }, { name: 'Đặt phòng', data: Array(12).fill(0) }, { name: 'Số khách', data: Array(12).fill(0) }] } };
            }

        } catch (error) {
            console.error(">>> Chi tiết lỗi khi tải dữ liệu:", error);
            allBookings = []; allCustomers = []; allRooms = [];
            aggregatedDashboardData = { revenueChart: { categories: [], series: [] } };
            throw error;
        }
    }

    // === HÀM TIỆN ÍCH PARSE NGÀY ===
    function parseVNDateTime(dateTimeString) {
        if (!dateTimeString) return null;
        try {
            // Thử parse trực tiếp (dành cho ISO strings như 2025-10-29T17:10:00)
            let date = new Date(dateTimeString);
            if (!isNaN(date.getTime())) return date;

            // Xử lý chuỗi "dd/MM/yyyy HH:mm"
            const parts = dateTimeString.split(' ');
            const dateParts = parts[0].split('/');
            const timeParts = parts[1] ? parts[1].split(':') : [0, 0];

            if (dateParts.length === 3) {
                date = new Date(
                    dateParts[2],      // Năm
                    dateParts[1] - 1,  // Tháng (bắt đầu từ 0)
                    dateParts[0],      // Ngày
                    (timeParts[0] || 0), // Giờ
                    (timeParts[1] || 0)  // Phút
                );
                if (!isNaN(date.getTime())) return date;
            }
            return null;
        } catch (e) {
            return null;
        }
    }

    function processBookingDataForChart() {
        console.log("Bắt đầu xử lý dữ liệu booking (chỉ cho biểu đồ)...");
        aggregatedDashboardData = { revenueChart: null }; // Chỉ cần dữ liệu biểu đồ
        const yearlyRevenue = {}; // Dùng cho biểu đồ năm hiện tại

        const now = new Date();
        const currentYear = now.getFullYear();

        let processedCount = 0;
        allBookings.forEach(booking => {
            const isValidBooking = booking.status === 'checked-out';
            const revenue = isValidBooking ? (parseFloat(booking.total) || 0) : 0;
            const guestCount = (parseInt(booking.soNguoiLon) || 0) + (parseInt(booking.soTreEm) || 0);
            let relevantDateString = booking.created;
            if (booking.status === 'checked-out' && booking.checkout) { relevantDateString = booking.checkout; }
            const bookingDate = parseVNDateTime(relevantDateString);
            if (!bookingDate) {
                console.warn(`[Chart] Không thể parse ngày: ${relevantDateString} cho booking: ${booking.code}`);
                return;
            }
            processedCount++;
            const year = bookingDate.getFullYear();
            const month = bookingDate.getMonth(); // 0-11
            if (year === currentYear) {
                const chartMonthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
                if (!yearlyRevenue[chartMonthKey]) yearlyRevenue[chartMonthKey] = { revenue: 0, bookings: 0, customers: new Set(), totalGuests: 0 };
                if (isValidBooking) {
                    yearlyRevenue[chartMonthKey].revenue += revenue;
                    yearlyRevenue[chartMonthKey].customers.add(booking.customerId);
                    yearlyRevenue[chartMonthKey].totalGuests += guestCount;
                }
                yearlyRevenue[chartMonthKey].bookings++;
            }
        });
        console.log(`Đã xử lý thành công ${processedCount} / ${allBookings.length} bookings cho biểu đồ.`);
        const revenueChartData = { categories: [], series: [{ name: 'Doanh thu', data: [] }, { name: 'Đặt phòng', data: [] }, { name: 'Khách hàng', data: [] }] };
        for (let m = 1; m <= 12; m++) {
            const monthKey = `${currentYear}-${String(m).padStart(2, '0')}`;
            revenueChartData.categories.push(`${m}/${currentYear}`);
            const data = yearlyRevenue[monthKey] || { revenue: 0, bookings: 0, customers: new Set(), totalGuests: 0 };
            revenueChartData.series[0].data.push(data.revenue || 0);
            revenueChartData.series[1].data.push(data.bookings || 0);
            revenueChartData.series[2].data.push(data.totalGuests || 0);
        }
        aggregatedDashboardData.revenueChart = revenueChartData;
        console.log("Dữ liệu biểu đồ đã xử lý xong:", aggregatedDashboardData.revenueChart);
    }

    function updateDashboard() {
        console.log(`Bắt đầu cập nhật dashboard...`);
        if (!aggregatedDashboardData || !allCustomers || !allRooms) {
            console.warn("Dữ liệu dashboard chưa sẵn sàng để cập nhật UI.");
            return;
        };
        renderRevenueChart();
        renderRoomStatusChart();
        renderRecentBookings();
        renderActivityFeed();
        console.log(`Cập nhật dashboard hoàn tất.`);
    }

    function initializeCharts() {
        console.log("Khởi tạo biểu đồ...");
        const revenueChartEl = document.querySelector("#revenueChart");
        if (revenueChartEl && typeof ApexCharts !== 'undefined') {
            revenueChartInstance = new ApexCharts(revenueChartEl, {
                chart: { height: 350, type: 'area', toolbar: { show: false }, },
                markers: { size: 4 },
                colors: ['#4154f1', '#2eca6a', '#ff9900'],
                fill: { type: "gradient", gradient: { shadeIntensity: 1, opacityFrom: 0.3, opacityTo: 0.4, stops: [0, 90, 100] } },
                dataLabels: { enabled: false },
                stroke: { curve: 'smooth', width: 2 },
                series: [],
                xaxis: { categories: [] },
                yaxis: [
                    {
                        axisTicks: { show: true },
                        axisBorder: { show: true, color: '#4154f1' },
                        labels: { style: { colors: '#4154f1' }, formatter: function (val) { return (val / 1000000).toFixed(0) + " Tr"; } },
                        title: { text: "Doanh thu (triệu VND)", style: { color: '#4154f1', fontWeight: 600 } }
                    },
                    {
                        opposite: true,
                        axisTicks: { show: true },
                        axisBorder: { show: true, color: '#2eca6a' },
                        labels: { style: { colors: '#2eca6a' }, formatter: function (val) { return val.toFixed(0); } },
                        title: { text: "Số lượt / Khách hàng", style: { color: '#2eca6a', fontWeight: 600 } },
                        min: 0
                    }
                ],
                tooltip: {
                    y: [
                        { formatter: val => `${((val||0)/1e6).toFixed(2)} triệu VND` },
                        { formatter: val => `${val||0} lượt` },
                        { formatter: val => `${val||0} khách hàng` }
                    ]
                }
            });
            try { revenueChartInstance.render(); console.log("Biểu đồ doanh thu (Dual-Axis) đã render."); } catch(e) { console.error("Lỗi render ApexCharts:", e); }
        } else { console.warn("Không tìm thấy #revenueChart hoặc ApexCharts."); }
        const roomStatusChartEl = document.querySelector("#roomStatusChart");
        if (roomStatusChartEl && typeof echarts !== 'undefined') {
            try {
                roomStatusChartInstance = echarts.init(roomStatusChartEl);
                roomStatusChartInstance.setOption({
                    tooltip: { trigger: 'item', formatter: '{a} <br/>{b}: {c} ({d}%)' },
                    legend: { top: '5%', left: 'center' },
                    series: [{
                        name: 'Tình trạng Phòng',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        label: { show: false, position: 'center' },
                        emphasis: { label: { show: true, fontSize: '18', fontWeight: 'bold' } },
                        labelLine: { show: false },
                        data: []
                    }]
                });
                console.log("Biểu đồ trạng thái phòng đã khởi tạo.");
            } catch (e) { console.error("Lỗi khởi tạo ECharts:", e); }
        } else { console.warn("Không tìm thấy #roomStatusChart hoặc ECharts."); }
    }
    function renderRevenueChart() {
        const chartData = aggregatedDashboardData.revenueChart;
        if (!revenueChartInstance || !chartData || !chartData.series || !chartData.categories) { console.warn("Chưa thể cập nhật biểu đồ doanh thu."); return; }
        console.log("Cập nhật biểu đồ doanh thu...");
        try { revenueChartInstance.updateOptions({ xaxis:{categories:chartData.categories}, series:chartData.series, tooltip:{y:[{formatter:val=>`${((val||0)/1e6).toFixed(2)} triệu VND`},{formatter:val=>`${val||0} lượt`},{formatter:val=>`${val||0} khách hàng`}]} }); } catch(e) { console.error("Lỗi update ApexCharts:", e); }
    }
    function renderRoomStatusChart() {
        if (!roomStatusChartInstance) return;
        const statusCounts = getRoomStatusCounts();
        const chartData = [
            { value: statusCounts.OCCUPIED, name: 'Đang sử dụng',itemStyle: { color: '#198754' } },
            { value: statusCounts.AVAILABLE, name: 'Trống',itemStyle: { color: '#0dcaf0' } },
            { value: statusCounts.MAINTENANCE, name: 'Bảo trì',itemStyle: { color: '#dc3545' } },
            { value: statusCounts.CLEANING, name: 'Đang dọn dẹp',itemStyle: { color: '#ffc107' } },
            { value: statusCounts.RESERVED, name: 'Đã đặt trước',itemStyle: { color: '#6f42c1' } }
        ].filter(item => item.value > 0);

        roomStatusChartInstance.setOption({
            series: [{ data: chartData }]
        });
    }
    function renderRecentBookings() {
        console.log("Render bảng đặt phòng gần đây...");
        const tableElement = document.querySelector("#recentBookingsTable"); if(!tableElement){console.error("Không tìm thấy table #recentBookingsTable"); return;}
        if (datatableInstance) { console.log("Hủy instance SimpleDatatables cũ."); try{datatableInstance.destroy();}catch(e){console.warn("Lỗi hủy SimpleDatatables:",e);} datatableInstance=null; const tbody=tableElement.querySelector('tbody'); if(tbody)tbody.innerHTML='<tr><td colspan="5" class="text-center">Đang tải...</td></tr>';}
        const recentBookings = allBookings.slice(0, 5);
        if (recentBookings.length === 0) { const tbody=tableElement.querySelector('tbody'); if(tbody)tbody.innerHTML='<tr><td colspan="5" class="text-center">Không có đặt phòng nào gần đây.</td></tr>'; console.log("Không có đặt phòng gần đây."); const controls = tableElement.closest('.recent-sales')?.querySelectorAll('.dataTable-top, .dataTable-bottom'); controls?.forEach(el=>el.remove()); return; }
        const tableData = { headings:["Mã","Khách hàng","Phòng","Ngày","Trạng thái"], data:recentBookings.map(b=>{const s=getStatusDetails(b.status); return [`<a href="#">${b.code||'#N/A'}</a>`, b.customer||'N/A', `<a href="#" class="text-primary">${b.roomType||''} ${b.roomNumber||'N/A'}</a>`, `${formatDate(b.checkin)} - ${formatDate(b.checkout)}`, `<span class="badge bg-${s.badge}">${s.text}</span>`];}) };
        try { if(typeof simpleDatatables === 'undefined') throw new Error("Thư viện SimpleDatatables chưa tải."); console.log("Khởi tạo SimpleDatatables..."); const labels={placeholder:"Tìm kiếm...",perPage:"{select} mục/trang",noRows:"Không có dữ liệu",info:"Hiển thị {start} đến {end} / {rows} mục",}; datatableInstance = new simpleDatatables.DataTable(tableElement,{data:tableData,searchable:!0,paging:!1,perPageSelect:!1,labels:labels,layout:{top:"{search}",bottom:"{info}"}}); console.log("SimpleDatatables đã khởi tạo."); }
        catch (e) { console.error("Lỗi khi khởi tạo SimpleDatatables:", e); const tbody = tableElement.querySelector('tbody'); if (tbody) { tbody.innerHTML=''; tableData.data.forEach(r => { tbody.innerHTML += `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td></tr>`; }); } }
    }
    function renderActivityFeed() {
        const activityDiv = document.querySelector('.activity');
        if (!activityDiv) { console.error("Không tìm thấy div .activity"); return; }
        activityDiv.innerHTML = '';
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const today = `${year}-${month}-${day}`;
        console.log("Đang lọc hoạt động cho ngày:", today);
        const todayActivities = allBookings
            .filter(b => {
                const status = b.status || '';
                if (b.checkin === today && (status === 'checked-in' || status === 'confirmed')) return true;
                if (b.checkout === today && (status === 'checked-out' || status === 'checked-in')) return true;
                return false;
            })
            .map(b => {
                let time;
                if(b.status === 'checked-in' && b.actualCheckinTime) { time = parseVNDateTime(b.actualCheckinTime); } else if (b.status === 'checked-out' && b.actualCheckoutTime) { time = parseVNDateTime(b.actualCheckoutTime); } else { time = parseVNDateTime(b.created) || new Date(0); }
                let type = 'unknown';
                if (b.checkin === today && b.status === 'checked-in') type = 'checkin_done';
                else if (b.checkin === today && b.status === 'confirmed') type = 'checkin_expected';
                else if (b.checkout === today && b.status === 'checked-out') type = 'checkout_done';
                else if (b.checkout === today && b.status === 'checked-in') type = 'checkout_expected';
                return { ...b, activityTime: time, activityType: type };
            })
            .filter(b => b.activityType !== 'unknown')
            .sort((a, b) => {
                const priority = { 'checkin_expected': 1, 'checkout_expected': 1, 'checkin_done': 2, 'checkout_done': 2 };
                if (priority[a.activityType] !== priority[b.activityType]) {
                    return priority[a.activityType] - priority[b.activityType];
                }
                return b.activityTime.getTime() - a.activityTime.getTime();
            })
            .slice(0, 5);
        console.log(`Tìm thấy ${todayActivities.length} hoạt động.`);
        if (todayActivities.length === 0) {
            activityDiv.innerHTML = '<div class="activity-item d-flex"><div class="text-muted">Không có hoạt động check-in/out hôm nay.</div></div>';
            return;
        }
        todayActivities.forEach(b => {
            let actType = '', bdgColor = 'text-info', timeLbl = "Hôm nay";
            const createdDate = parseVNDateTime(b.created) || new Date(0);
            let createdDateStr = '1970-01-01';
            try { const createdYear = createdDate.getFullYear(); const createdMonth = String(createdDate.getMonth() + 1).padStart(2, '0'); const createdDay = String(createdDate.getDate()).padStart(2, '0'); createdDateStr = `${createdYear}-${createdMonth}-${createdDay}`; } catch(e) {}
            switch (b.activityType) {
                case 'checkin_done':
                    actType = 'Đã check-in:'; bdgColor = 'text-success';
                    if (b.actualCheckinTime) { try { timeLbl = b.activityTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }); } catch(e) {} } else if (createdDateStr === today) { try { timeLbl = createdDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }); } catch(e) {} }
                    break;
                case 'checkin_expected':
                    actType = 'Check-in dự kiến:'; bdgColor = 'text-info'; timeLbl = "14:00";
                    break;
                case 'checkout_done':
                    actType = 'Đã check-out:'; bdgColor = 'text-secondary';
                    if (b.actualCheckoutTime) { try { timeLbl = b.activityTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }); } catch(e) {} }
                    break;
                case 'checkout_expected':
                    actType = 'Check-out dự kiến:'; bdgColor = 'text-primary'; timeLbl = "12:00";
                    break;
            }
            activityDiv.innerHTML += `<div class="activity-item d-flex">
                <div class="activite-label">${timeLbl}</div>
                <i class='bi bi-circle-fill activity-badge ${bdgColor} align-self-start'></i>
                <div class="activity-content">${actType} <a href="#" class="fw-bold text-dark">Phòng ${b.roomNumber || 'N/A'} - ${b.customer || 'N/A'}</a></div>
            </div>`;
        });
    }

    // === HÀM TIỆN ÍCH (Giữ nguyên) ===
    function showLoadingState(isLoading) { document.body.classList.toggle('loading', isLoading); }
    function calculatePercentageChange(current, previous) { current=parseFloat(current)||0; previous=parseFloat(previous)||0; if(previous===0){return current>0?Infinity:(current===0?0:-Infinity);} if(isNaN(current)||isNaN(previous)) return NaN; return ((current-previous)/previous)*100; }
    function getInitials(name) { if (!name) return '?'; return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2); }
    function formatDate(dateStr) { if (!dateStr) return 'N/A'; try { const [y, m, d] = dateStr.split('-'); if (!y || !m || !d) return dateStr; return `${d}/${m}/${y}`; } catch(e) { return dateStr; } }
    function getStatusDetails(status) { const d = {'pending':{text:"Đang chờ",badge:"warning"},'confirmed':{text:"Đã xác nhận",badge:"success"},'checked-in':{text:"Đã check-in",badge:"info"},'checked-out':{text:"Đã check-out",badge:"secondary"},'cancelled':{text:"Đã hủy",badge:"danger"}}; const k=String(status).toLowerCase().replace('_','-'); return d[k]||{text:status, badge:"dark"}; }
    function getRoomStatusCounts() { const c = {AVAILABLE:0,OCCUPIED:0,MAINTENANCE:0,CLEANING:0,RESERVED:0}; allRooms.forEach(r=>{const k=String(r.status).toUpperCase(); if(c.hasOwnProperty(k))c[k]++; else console.warn("Trạng thái phòng lạ:",r.status)}); return c; }

</script>

</body>

</html>