<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Check-out - HotelAdmin</title>
    <link href="assets/img/img.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
    <style>
        .checkout-card {
            border-left: 4px solid #6c757d; /* Secondary color for check-out */
            transition: all 0.3s ease;
        }
        .checkout-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        /* today-highlight CSS (removed) */
        .late-checkout { /* Highlight late checkouts */
            border-left: 4px solid #dc3545 !important; /* Danger color */
            animation: pulse-checkout 1.5s infinite alternate;
        }
        @keyframes pulse-checkout { /* Different animation name */
            from { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            to { box-shadow: 0 0 0 5px rgba(220, 53, 69, 0); }
        }
        .customer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.875rem;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.35em 0.65em;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        .alert-custom {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }
        .checked-out-card { /* Optional styling for completed checkouts */
            border-left-color: #198754 !important; /* Success color */
            opacity: 0.7;
        }
    </style>
</head>
<body>

<header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
        <a href="index.html" class="logo d-flex align-items-center">
            <img src="assets/img/logo.png" alt="Logo">
            <span class="d-none d-lg-block">Grandoria</span>
        </a>
        <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><div class="search-bar">
    <form class="search-form d-flex align-items-center" method="POST" action="#">
        <input type="text" name="query" placeholder="Tìm kiếm đặt phòng, khách hàng..." title="Nhập từ khóa tìm kiếm">
        <button type="submit" title="Tìm kiếm"><i class="bi bi-search"></i></button>
    </form>
</div><nav class="header-nav ms-auto">
    <ul class="d-flex align-items-center">

        <li class="nav-item d-block d-lg-none">
            <a class="nav-link nav-icon search-bar-toggle " href="#">
                <i class="bi bi-search"></i>
            </a>
        </li><li class="nav-item dropdown">
        <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-bell"></i>
            <span class="badge bg-primary badge-number">3</span>
        </a><ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications">
        <li class="dropdown-header">
            Bạn có 3 thông báo mới
            <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">Xem tất cả</span></a>
        </li>
        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-exclamation-circle text-warning"></i>
            <div>
                <h4>Đặt phòng mới</h4>
                <p>Khách hàng Nguyễn Văn A vừa đặt phòng Deluxe</p>
                <p>5 phút trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-x-circle text-danger"></i>
            <div>
                <h4>Hủy đặt phòng</h4>
                <p>Đặt phòng #2457 đã bị hủy</p>
                <p>2 giờ trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>

        <li class="notification-item">
            <i class="bi bi-check-circle text-success"></i>
            <div>
                <h4>Phản hồi mới</h4>
                <p>Bạn có 2 đánh giá mới từ khách hàng</p>
                <p>4 giờ trước</p>
            </div>
        </li>

        <li>
            <hr class="dropdown-divider">
        </li>
        <li class="dropdown-footer">
            <a href="#">Hiển thị tất cả thông báo</a>
        </li>
    </ul></li><li class="nav-item dropdown pe-3">

        <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <img src="assets/img/profile-img.jpg" alt="Hồ sơ" class="rounded-circle">
            <span class="d-none d-md-block dropdown-toggle ps-2" id="profileName">Đang tải...</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li class="dropdown-header">
                <h6 id="profileDropdownName">...</h6>
                <span id="profileDropdownRole">...</span>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                    <i class="bi bi-person"></i>
                    <span>Hồ sơ của tôi</span>
                </a>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                    <i class="bi bi-gear"></i>
                    <span>Cài đặt tài khoản</span>
                </a>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>

            <li>
                <a class="dropdown-item d-flex align-items-center" href="#" id="logoutButton">
                    <i class="bi bi-box-arrow-right"></i>
                    <span>Đăng xuất</span>
                </a>
            </li>
        </ul></li></ul>
</nav>
</header><aside id="sidebar" class="sidebar">
    <ul class="sidebar-nav" id="sidebar-nav">
        <li class="nav-item"><a class="nav-link collapsed" href="index.html"><i class="bi bi-house-door"></i><span>Bảng Điều Khiển</span></a></li>
        <li class="nav-item">
            <a class="nav-link " data-bs-target="#booking-nav" data-bs-toggle="collapse" href="#"><i class="bi bi-calendar-check"></i><span>Quản lý Đặt phòng</span><i class="bi bi-chevron-down ms-auto"></i></a>
            <ul id="booking-nav" class="nav-content collapse show" data-bs-parent="#sidebar-nav">
                <li><a href="tatcadatphong.html"><i class="bi bi-circle"></i><span>Tất cả đặt phòng</span></a></li>
                <li><a href="checkin.html"><i class="bi bi-circle"></i><span>Check-in</span></a></li>
                <li><a href="checkout.html" class="active"><i class="bi bi-circle"></i><span>Check-out</span></a></li>
            </ul>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#room-nav" data-bs-toggle="collapse" href="#"><i class="bi bi-door-closed"></i><span>Quản lý Phòng</span><i class="bi bi-chevron-down ms-auto"></i></a>
            <ul id="room-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
                <li><a href="danhsachphong.html"><i class="bi bi-circle"></i><span>Danh sách phòng</span></a></li>
                <li><a href="loaiphong.html"><i class="bi bi-circle"></i><span>Loại phòng</span></a></li>
                <li><a href="tinhtrangphong.html"><i class="bi bi-circle"></i><span>Tình trạng phòng</span></a></li>
                <li><a href="giaphong.html"><i class="bi bi-circle"></i><span>Giá phòng</span></a></li>
            </ul>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#customer-nav" data-bs-toggle="collapse" href="#"><i class="bi bi-people"></i><span>Quản lý Khách hàng</span><i class="bi bi-chevron-down ms-auto"></i></a>
            <ul id="customer-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
                <li><a href="danhsachkhachhang.html"><i class="bi bi-circle"></i><span>Danh sách khách hàng</span></a></li>
                <li><a href="chuongtrinhthanhvien.html"><i class="bi bi-circle"></i><span>Chương trình thành viên</span></a></li>
                <li><a href="danhgia&phanhoi.html"><i class="bi bi-circle"></i><span>Đánh giá & Phản hồi</span></a></li>
            </ul>
        </li>
        <li class="nav-item"><a class="nav-link collapsed" href="baocao&thongke.html"><i class="bi bi-bar-chart"></i><span>Báo cáo & Thống kê</span></a></li>
        <li class="nav-item">
            <a class="nav-link collapsed" data-bs-target="#finance-nav" data-bs-toggle="collapse" href="#"><i class="bi bi-cash-coin"></i><span>Tài chính</span><i class="bi bi-chevron-down ms-auto"></i></a>
            <ul id="finance-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
                <li><a href="finance-invoices.html"><i class="bi bi-circle"></i><span>Hóa đơn</span></a></li>
                <li><a href="finance-payments.html"><i class="bi bi-circle"></i><span>Thanh toán</span></a></li>
                <li><a href="finance-revenue.html"><i class="bi bi-circle"></i><span>Doanh thu</span></a></li>
            </ul>
        </li>
        <li class="nav-heading">Trang</li>
        <li class="nav-item"><a class="nav-link collapsed" href="users-profile.html"><i class="bi bi-person"></i><span>Hồ sơ</span></a></li>
        <li class="nav-item"><a class="nav-link collapsed" href="pages-contact.html"><i class="bi bi-envelope"></i><span>Liên hệ</span></a></li>
        <li class="nav-item"><a class="nav-link collapsed" href="users.html"><i class="bi bi-person-gear"></i><span>Nhân viên</span></a></li>
        <li class="nav-item"><a class="nav-link collapsed" href="taikhoan.html"><i class="bi bi-person-badge"></i><span>Tài khoản</span></a></li>
        <li class="nav-item"><a class="nav-link collapsed" href="settings.html"><i class="bi bi-gear"></i><span>Cài đặt</span></a></li>
    </ul>
</aside><main id="main" class="main">
    <div class="pagetitle d-flex justify-content-between align-items-center">
        <h1>Check-out</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
                <li class="breadcrumb-item">Quản lý Đặt phòng</li>
                <li class="breadcrumb-item active">Check-out</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title">Danh sách chờ check-out</h5>
                            <div><button class="btn btn-outline-primary" onclick="loadCheckouts(true)"><i class="bi bi-arrow-clockwise"></i> Làm mới</button></div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label class="form-label">Ngày trả phòng từ</label>
                                <input type="date" class="form-control" id="filterCheckoutDateFrom">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Ngày trả phòng đến</label>
                                <input type="date" class="form-control" id="filterCheckoutDateTo">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Trạng thái Check-out</label>
                                <select class="form-select" id="filterCheckoutStatus">
                                    <option value="all" selected>Tất cả chờ & trễ</option>
                                    <option value="ontime">Chờ (đúng hạn)</option>
                                    <option value="late">Trả phòng trễ</option>
                                    {/* Có thể thêm nếu cần */}
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-primary w-100" id="filterBtn">Lọc</button>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label">Loại phòng</label>
                                <select class="form-select" id="filterRoomType">
                                    <option value="" selected>Tất cả loại phòng</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Tìm kiếm</label>
                                <input type="text" class="form-control" placeholder="Mã đặt phòng, tên, SĐT..." id="searchInput">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="showLateOnly">
                                    <label class="form-check-label" for="showLateOnly">Chỉ hiển thị trả trễ</label>
                                </div>
                            </div>
                        </div>

                        <div class="loading-spinner" id="loadingSpinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Đang tải...</span></div><p class="mt-2">Đang tải dữ liệu...</p></div>

                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="checkoutContainer">
                        </div>

                        <div class="empty-state d-none" id="emptyState"><i class="bi bi-calendar-x"></i><h4>Không có đặt phòng chờ check-out</h4><p>Không tìm thấy đặt phòng nào có trạng thái "Đã check-in" phù hợp.</p><button class="btn btn-primary" onclick="resetFilters()"><i class="bi bi-arrow-clockwise"></i> Đặt lại bộ lọc</button></div>

                        <nav aria-label="Page navigation" id="paginationContainer"><ul class="pagination justify-content-center" id="pagination"></ul></nav>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<div class="modal fade" id="bookingDetailModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Chi tiết đặt phòng</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="bookingDetailContent"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button><button type="button" class="btn btn-primary" onclick="processCheckoutFromDetail()">Tiến hành Check-out</button></div></div></div></div>

<div class="modal fade" id="checkoutModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Xác nhận Check-out</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row"><div class="col-md-6"><h6>Thông tin khách hàng</h6><div class="mb-3" id="checkoutCustomerInfo"></div></div><div class="col-md-6"><h6>Thanh toán</h6><div class="mb-3" id="checkoutPaymentInfo"></div></div></div><hr><div class="mb-3"><label class="form-label">Tình trạng phòng sau khi trả</label><select class="form-select" id="roomCondition"><option value="CLEANING" selected>Cần dọn dẹp</option><option value="AVAILABLE">Sẵn sàng (đã dọn)</option><option value="MAINTENANCE">Cần bảo trì</option></select></div><div class="mb-3"><label class="form-label">Ghi chú check-out</label><textarea class="form-control" rows="3" id="checkoutNotes" placeholder="Ghi chú về tình trạng phòng, đồ đạc bị mất/hỏng..."></textarea></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="confirmCheckout"><label class="form-check-label" for="confirmCheckout">Xác nhận khách hàng đã trả phòng và thanh toán đầy đủ</label></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button type="button" class="btn btn-outline-secondary" id="checkoutConfirmBtn">Xác nhận Check-out</button></div></div></div></div>

<footer id="footer" class="footer"><div class="copyright">&copy; Bản quyền <strong><span>HotelAdmin</span></strong>. Tất cả các quyền được bảo lưu</div><div class="credits">Thiết kế bởi <a href="#">Nhóm Phát triển</a></div></footer>

<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/main.js"></script>
<script src="assets/js/auth.js"></script>
<script>

    // === CẤU HÌNH VÀ BIẾN TOÀN CỤC ===
    const API_BASE_URL = '/api/admin';
    let allCheckoutBookings = []; // Dữ liệu gốc từ API
    let filteredCheckouts = []; // Dữ liệu đã lọc
    let currentProcessingBooking = null;
    let roomTypes = [];

    let currentPage = 0;
    const itemsPerPage = 6;
    let totalPages = 0;

    // === KHỞI TẠO TRANG ===
    document.addEventListener('DOMContentLoaded', async () => {
        initializePageDefaults();
        await loadRoomTypes();
        setupEventListeners();
        await loadCheckouts(true);
    });

    function initializePageDefaults() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filterCheckoutDateFrom').value ;
        document.getElementById('filterCheckoutDateTo').value ;
    }

    async function loadRoomTypes() {
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/room-types`);
            if (!response.ok) throw new Error('Lỗi tải loại phòng');
            roomTypes = await response.json();
            const select = document.getElementById('filterRoomType');
            select.innerHTML = '<option value="" selected>Tất cả loại phòng</option>';
            roomTypes.forEach(rt => {
                select.innerHTML += `<option value="${rt.id}">${rt.name}</option>`;
            });
        } catch (error) {
            // === SỬA LỖI GIỐNG CHECKIN.HTML ===
            if (error.message !== 'Phiên đăng nhập hết hạn' && error.message !== 'Unauthorized') {
                console.error("Lỗi tải loại phòng:", error);
                showAlert('Không thể tải danh sách loại phòng.', 'danger');
            }
        }
    }

    function setupEventListeners() {
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { applyFiltersAndFetch(); }, 300);
        });
        document.getElementById('filterBtn').onclick = applyFiltersAndFetch;
        document.getElementById('filterCheckoutStatus').addEventListener('change', applyFiltersAndFetch);
        document.getElementById('filterRoomType').addEventListener('change', applyFiltersAndFetch);
        document.getElementById('filterCheckoutDateFrom').addEventListener('change', applyFiltersAndFetch);
        document.getElementById('filterCheckoutDateTo').addEventListener('change', applyFiltersAndFetch);
        document.getElementById('showLateOnly').addEventListener('change', applyFiltersAndFetch);
        document.getElementById('checkoutContainer').addEventListener('click', handleCheckoutActions);
        document.getElementById('checkoutConfirmBtn').onclick = confirmCheckoutAction;
    }

    // === TẢI VÀ HIỂN THỊ DỮ LIỆU ===
    async function loadCheckouts(resetPage = false) {
        showLoading();
        if (resetPage) currentPage = 0;

        const params = new URLSearchParams();
        params.append('page', currentPage);
        params.append('size', itemsPerPage);
        params.append('sort', 'checkOutDate,asc');
        params.append('status', 'CHECKED_IN');

        const fromDate = document.getElementById('filterCheckoutDateFrom').value;
        const toDate = document.getElementById('filterCheckoutDateTo').value;
        const roomTypeId = document.getElementById('filterRoomType').value;
        const searchTerm = document.getElementById('searchInput').value.trim();
        const checkoutStatusFilter = document.getElementById('filterCheckoutStatus').value;
        const showLateOnly = document.getElementById('showLateOnly').checked;

        if (fromDate) params.append('checkoutFrom', fromDate);
        if (toDate) params.append('checkoutTo', toDate);
        if (roomTypeId) params.append('roomTypeId', roomTypeId);
        if (searchTerm) params.append('search', searchTerm);

        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/bookings?${params.toString()}`);
            if (!response.ok) {
                let errorMsg = 'Lỗi tải danh sách check-out.';
                try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; } catch(e) {}
                throw new Error(errorMsg);
            }

            const pageData = await response.json();
            allCheckoutBookings = pageData.content || [];
            totalPages = pageData.totalPages || 0;

            applyClientSideCheckoutFilters(checkoutStatusFilter, showLateOnly);

            renderCheckouts();
            renderPagination(pageData);

        } catch (error) {
            // === SỬA LỖI GIỐNG CHECKIN.HTML ===
            if (error.message !== 'Phiên đăng nhập hết hạn' && error.message !== 'Unauthorized') {
                console.error('Lỗi khi tải check-outs:', error);
                showAlert(error.message || 'Có lỗi xảy ra khi tải dữ liệu.', 'danger');
                document.getElementById('checkoutContainer').innerHTML = '';
                document.getElementById('pagination').innerHTML = '';
                showEmptyStateIfNeeded();
            }
        } finally {
            hideLoading();
        }
    }

    function applyClientSideCheckoutFilters(checkoutStatusFilter, showLateOnly) {
        const todayStr = new Date().toISOString().split('T')[0];
        filteredCheckouts = allCheckoutBookings.filter(booking => {
            const checkoutDate = booking.checkout; // Dùng camelCase
            let currentCheckoutStatus = 'ontime'; // Mặc định
            if (checkoutDate < todayStr) {
                currentCheckoutStatus = 'late';
            }
            if (showLateOnly && currentCheckoutStatus !== 'late') {
                return false;
            }
            if (checkoutStatusFilter !== 'all' && currentCheckoutStatus !== checkoutStatusFilter) {
                return false;
            }
            return true;
        });
    }

    function applyFiltersAndFetch() {
        loadCheckouts(true);
    }

    function renderCheckouts() {
        const container = document.getElementById('checkoutContainer');
        container.innerHTML = '';
        if (filteredCheckouts.length === 0) {
            showEmptyStateIfNeeded();
            return;
        }
        hideEmptyState();
        const fragment = document.createDocumentFragment();
        filteredCheckouts.forEach(booking => {
            const checkoutElement = createCheckoutElement(booking);
            fragment.appendChild(checkoutElement);
        });
        container.appendChild(fragment);
    }

    function createCheckoutElement(booking) {
        const colDiv = document.createElement('div');
        colDiv.className = 'col';

        const todayStr = new Date().toISOString().split('T')[0];
        const checkoutDate = booking.checkout;
        let checkoutStatus = 'ontime';
        if (checkoutDate < todayStr) {
            checkoutStatus = 'late';
        }

        colDiv.innerHTML = `
            <div class="card checkout-card ${checkoutStatus === 'late' ? 'late-checkout' : ''}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="card-title mb-1">${booking.code || 'N/A'}</h6>

                        </div>
                        <div>
                            <span class="badge ${getCheckoutStatusBadgeClass(checkoutStatus)} status-badge">
                                ${getCheckoutStatusText(checkoutStatus)}
                            </span>
                        </div>
                    </div>
                    <div class="customer-info mb-3">
                        <div class="d-flex align-items-center mb-2">
                             <div class="customer-avatar ${getAvatarColor(getInitials(booking.customer || ''))} me-2">
                                ${getInitials(booking.customer || '?')}
                            </div>
                            <div>
                                <div class="fw-bold">${booking.customer || 'N/A'}</div>

                            </div>
                        </div>
                    </div>
                    <div class="booking-info">
                         <div class="row">
                            <div class="row">
                                <div class="fw-bold">${booking.roomType || 'N/A'} ${booking.roomNumber || 'N/A'}</div>
                            </div>
                             <div class="row">
                                <small class="text-muted">Thời gian </small>
                                <div>${formatDate(booking.checkin)} - ${formatDate(booking.checkout)}</div>

                             </div>
                        </div>

                    </div>
                    <div class="checkout-actions mt-3">
                        <div class="btn-group w-100">
                            <button class="btn btn-sm btn-outline-primary" data-booking-id="${booking.id}">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" data-booking-id="${booking.id}">
                                <i class="bi bi-box-arrow-right"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" data-phone="${booking.phone || ''}">
                                <i class="bi bi-telephone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        return colDiv;
    }

    // === XỬ LÝ HÀNH ĐỘNG ===
    function handleCheckoutActions(e) {
        const button = e.target.closest('button');
        if (!button) return;

        const bookingId = button.dataset.bookingId;
        const phone = button.dataset.phone;

        if (button.classList.contains('btn-outline-primary') && bookingId) {
            viewBookingDetail(bookingId);
        } else if (button.classList.contains('btn-secondary') && bookingId) { // Changed class
            openCheckoutModal(bookingId);
        } else if (button.classList.contains('btn-outline-warning') && phone) {
            callCustomer(phone);
        }
    }

    async function viewBookingDetail(bookingId) {
        showLoading();
        try {
            let booking = filteredCheckouts.find(b => b.id == bookingId);
            if (!booking) {
                const response = await fetchWithAuth(`${API_BASE_URL}/bookings/${bookingId}`);
                if (!response.ok) throw new Error('Không tìm thấy chi tiết đặt phòng.');
                booking = await response.json();
            }
            currentProcessingBooking = booking;

            const modalContent = document.getElementById('bookingDetailContent');
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6"><h6>Thông tin khách hàng</h6><div class="mb-3"><strong>Họ tên:</strong> ${booking.customer || 'N/A'}<br><strong>SĐT:</strong> ${booking.phone || 'N/A'}<br></div></div>
                    <div class="col-md-6"><h6>Thông tin đặt phòng</h6><div class="mb-3"><strong>Mã đặt phòng:</strong> ${booking.code || 'N/A'}<br><strong>Phòng:</strong> ${booking.roomType || 'N/A'} ${booking.roomNumber || 'N/A'}<br><strong>Thời gian:</strong> ${formatDate(booking.checkin)} - ${formatDate(booking.checkout)}<br><strong>Số đêm:</strong> ${calculateNights(booking.checkin, booking.checkout)} đêm<br><strong>Tổng tiền:</strong> ${formatCurrency(booking.total || 0)}<br><strong>Trạng thái:</strong> <span class="badge bg-info">${getStatusText(booking.status)}</span></div></div>
                </div>
                ${booking.notes ? `<div class="row"><div class="col-12"><h6>Ghi chú</h6><p>${booking.notes}</p></div></div>` : ''}
            `;
            new bootstrap.Modal(document.getElementById('bookingDetailModal')).show();
        } catch(error){
            // === SỬA LỖI GIỐNG CHECKIN.HTML ===
            if (error.message !== 'Phiên đăng nhập hết hạn' && error.message !== 'Unauthorized') {
                showAlert(error.message || 'Lỗi khi xem chi tiết.', 'danger');
            }
        } finally {
            hideLoading();
        }
    }

    function processCheckoutFromDetail() {
        const detailModal = bootstrap.Modal.getInstance(document.getElementById('bookingDetailModal'));
        if (detailModal) detailModal.hide();
        if (currentProcessingBooking) {
            setTimeout(() => { openCheckoutModal(currentProcessingBooking.id); }, 300);
        } else {
            showAlert('Không có thông tin đặt phòng để check-out.', 'warning');
        }
    }

    function openCheckoutModal(bookingId) {
        const booking = filteredCheckouts.find(b => b.id == bookingId);
        if (!booking) {
            showAlert('Không tìm thấy thông tin đặt phòng trong danh sách hiện tại!', 'danger');
            return;
        }
        currentProcessingBooking = booking;

        document.getElementById('checkoutCustomerInfo').innerHTML = `<strong>Họ tên:</strong> ${booking.customer || 'N/A'}<br><strong>SĐT:</strong> ${booking.phone || 'N/A'}<br><strong>Phòng:</strong> ${booking.roomType || 'N/A'} ${booking.roomNumber || 'N/A'}<br><strong>Thời gian:</strong> ${formatDate(booking.checkin)} - ${formatDate(booking.checkout)}`;
        document.getElementById('checkoutPaymentInfo').innerHTML = `<strong class="text-primary">Tổng tiền: ${formatCurrency(booking.total || 0)}</strong><br><small>(Kiểm tra thanh toán và các chi phí phát sinh nếu có)</small>`;

        document.getElementById('confirmCheckout').checked = false;
        document.getElementById('checkoutNotes').value = '';
        document.getElementById('roomCondition').value = 'CLEANING'; // Default to cleaning

        new bootstrap.Modal(document.getElementById('checkoutModal')).show();
    }

    async function confirmCheckoutAction() {
        if (!document.getElementById('confirmCheckout').checked) {
            showAlert('Vui lòng xác nhận khách hàng đã trả phòng và thanh toán!', 'warning');
            return;
        }
        if (!currentProcessingBooking) {
            showAlert('Lỗi: Không tìm thấy thông tin đặt phòng đang xử lý!', 'danger');
            return;
        }

        const bookingId = currentProcessingBooking.id;
        const roomCondition = document.getElementById('roomCondition').value;
        const checkoutNotes = document.getElementById('checkoutNotes').value;

        showLoading();
        const checkoutModalInstance = bootstrap.Modal.getInstance(document.getElementById('checkoutModal'));

        try {
            // Step 1: Update Booking Status
            const responseBooking = await fetchWithAuth(`${API_BASE_URL}/bookings/${bookingId}/status`, {
                method: 'PATCH',
                body: { status: 'CHECKED_OUT' }
            });
            if (!responseBooking.ok) {
                const errorData = await responseBooking.json();
                throw new Error(errorData.message || 'Lỗi khi cập nhật trạng thái check-out.');
            }

            // Step 2 (Optional but Recommended): Update Room Status
            const roomId = currentProcessingBooking.roomId; // Make sure roomId is in your Booking DTO
            if (roomId && roomCondition) {
                try {
                    const responseRoom = await fetchWithAuth(`${API_BASE_URL}/rooms/${roomId}/status`, {
                        method: 'PATCH',
                        body: { status: roomCondition }
                    });
                    if (!responseRoom.ok) {
                        console.warn(`Không thể cập nhật trạng thái phòng ${roomId} sang ${roomCondition}.`);
                    }
                } catch (roomError) {
                    console.error(`Lỗi khi cập nhật trạng thái phòng ${roomId}:`, roomError);
                }
            } else {
                console.warn(`Không thể cập nhật trạng thái phòng: roomId=${roomId}, roomCondition=${roomCondition}`);
            }

            // Success
            if(checkoutModalInstance) checkoutModalInstance.hide();
            showAlert('Check-out thành công!', 'success');
            await loadCheckouts(true); // Refresh list

        } catch (error) {
            // === SỬA LỖI GIỐNG CHECKIN.HTML ===
            if (error.message !== 'Phiên đăng nhập hết hạn' && error.message !== 'Unauthorized') {
                console.error('Lỗi khi xác nhận check-out:', error);
                showAlert(error.message || 'Có lỗi xảy ra trong quá trình check-out.', 'danger');
            }
        } finally {
            hideLoading();
        }
    }


    function callCustomer(phone) {
        if (phone) {
            showAlert(`Đang gọi đến số: ${phone}... (Giả lập)`, 'info');
        } else {
            showAlert('Không có số điện thoại để gọi.', 'warning');
        }
    }

    // === PHÂN TRANG ===
    function renderPagination(pageData) {
        const paginationUl = document.getElementById('pagination');
        paginationUl.innerHTML = '';
        totalPages = pageData.totalPages || 0;
        currentPage = pageData.number || 0;
        if (totalPages <= 1) return;

        paginationUl.innerHTML += `<li class="page-item ${pageData.first ? 'disabled' : ''}"><a class="page-link" href="#" aria-label="Previous" onclick="changePage(${currentPage - 1}); return false;"><span aria-hidden="true">&laquo;</span></a></li>`;
        const maxPagesToShow = 5;
        let startPage = Math.max(0, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages - 1, startPage + maxPagesToShow - 1);
        if (endPage === totalPages - 1) { startPage = Math.max(0, endPage - maxPagesToShow + 1); }
        if (startPage > 0) {
            paginationUl.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(0); return false;">1</a></li>`;
            if (startPage > 1) paginationUl.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        for (let i = startPage; i <= endPage; i++) {
            paginationUl.innerHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="changePage(${i}); return false;">${i + 1}</a></li>`;
        }
        if (endPage < totalPages - 1) {
            if (endPage < totalPages - 2) paginationUl.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            paginationUl.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages - 1}); return false;">${totalPages}</a></li>`;
        }
        paginationUl.innerHTML += `<li class="page-item ${pageData.last ? 'disabled' : ''}"><a class="page-link" href="#" aria-label="Next" onclick="changePage(${currentPage + 1}); return false;"><span aria-hidden="true">&raquo;</span></a></li>`;
    }

    function changePage(page) {
        if (page < 0 || page >= totalPages) return;
        currentPage = page;
        loadCheckouts(false);
    }

    // === CẬP NHẬT THỐNG KÊ (ĐÃ BỊ XÓA) ===
    // function updateCheckoutStatistics(bookingsForStats = []) { ... }

    // === HÀM TIỆN ÍCH ===
    function showLoading() { document.getElementById('loadingSpinner').style.display = 'block'; }
    function hideLoading() { document.getElementById('loadingSpinner').style.display = 'none'; }
    function showEmptyStateIfNeeded() {
        const container = document.getElementById('checkoutContainer'); // Use correct ID
        const emptyState = document.getElementById('emptyState');
        const paginationContainer = document.getElementById('paginationContainer');
        if (!container || container.children.length === 0) { // Check if container exists
            if(emptyState) emptyState.classList.remove('d-none');
            if(paginationContainer) paginationContainer.classList.add('d-none');
        } else {
            if(emptyState) emptyState.classList.add('d-none');
            if(paginationContainer) paginationContainer.classList.remove('d-none');
        }
    }
    function hideEmptyState() { const es = document.getElementById('emptyState'); if(es) es.classList.add('d-none'); }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try { const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; }
        catch (e) { return dateString; }
    }
    function calculateNights(checkinStr, checkoutStr) {
        try {
            const checkin = new Date(checkinStr + 'T00:00:00');
            const checkout = new Date(checkoutStr + 'T00:00:00');
            const diffTime = Math.abs(checkout - checkin);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 1;
        } catch (e) { return '?'; }
    }
    function formatCurrency(amount) {
        if (amount == null || isNaN(amount)) return '0 VNĐ';
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }
    function getCheckoutStatusBadgeClass(status) { // Status here is 'ontime' or 'late'
        return status === 'late' ? 'bg-danger' : 'bg-success'; // Use success for ontime
    }
    function getCheckoutStatusText(status) { // Status here is 'ontime' or 'late'
        return status === 'late' ? 'Trả phòng trễ' : 'Chờ trả phòng';
    }
    function getStatusText(apiStatus) {
        const texts = { 'PENDING': 'Đang chờ', 'CONFIRMED': 'Đã xác nhận', 'CHECKED_IN': 'Đã check-in', 'CHECKED_OUT': 'Đã check-out', 'CANCELLED': 'Đã hủy' };
        return texts[apiStatus] || apiStatus;
    }
    function getInitials(name) {
        if (!name) return '?';
        return name.split(' ').map(w => w ? w[0] : '').join('').toUpperCase().slice(0, 2);
    }
    function getAvatarColor(initials) {
        const colors = ['bg-primary', 'bg-success', 'bg-warning', 'bg-info', 'bg-danger', 'bg-secondary', 'bg-dark'];
        let hash = 0;
        for (let i = 0; i < initials.length; i++) { hash = initials.charCodeAt(i) + ((hash << 5) - hash); }
        const index = Math.abs(hash % colors.length);
        return colors[index];
    }
    function showAlert(message, type = 'info') {
        const existingAlert = document.getElementById('dynamicAlert');
        if(existingAlert) existingAlert.remove();
        const alert = document.createElement('div');
        alert.id = 'dynamicAlert';
        alert.className = `alert alert-${type} alert-dismissible fade show alert-custom`;
        alert.setAttribute('role', 'alert');
        alert.innerHTML = `<i class="bi ${type === 'success' ? 'bi-check-circle-fill' : type === 'warning' ? 'bi-exclamation-triangle-fill' : type === 'danger' ? 'bi-exclamation-octagon-fill' : 'bi-info-circle-fill'} me-2"></i> ${message} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
        document.body.appendChild(alert);
        setTimeout(() => { const currentAlert = document.getElementById('dynamicAlert'); if (currentAlert) { bootstrap.Alert.getOrCreateInstance(currentAlert).close(); } }, 5000);
    }
    // Hàm reset bộ lọc
    function resetFilters() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filterCheckoutDateFrom').value = today ;
        document.getElementById('filterCheckoutDateTo').value = today ;
        document.getElementById('filterCheckoutStatus').value = 'all';
        document.getElementById('filterRoomType').value = '';
        document.getElementById('searchInput').value = '';
        document.getElementById('showLateOnly').checked = false;
        applyFiltersAndFetch();
    }
</script>

</body>
</html>